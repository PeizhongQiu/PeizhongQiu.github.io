<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"peizhongqiu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="源代码仓库RVM1.5：https:&#x2F;&#x2F;github.com&#x2F;rvm-rtos&#x2F;RVM1.5&#x2F;tree&#x2F;mainJailhouse：https:&#x2F;&#x2F;github.com&#x2F;siemens&#x2F;jailhouse.gitJailhouse patch：https:&#x2F;&#x2F;github.com&#x2F;rvm-rtos&#x2F;RVM1.5&#x2F;blob&#x2F;main&#x2F;scripts&#x2F;guest&#x2F;jailhouse.patch">
<meta property="og:type" content="article">
<meta property="og:title" content="rvm1.5">
<meta property="og:url" content="https://peizhongqiu.github.io/p/30eb7570.html">
<meta property="og:site_name" content="Little Q 的个人博客">
<meta property="og:description" content="源代码仓库RVM1.5：https:&#x2F;&#x2F;github.com&#x2F;rvm-rtos&#x2F;RVM1.5&#x2F;tree&#x2F;mainJailhouse：https:&#x2F;&#x2F;github.com&#x2F;siemens&#x2F;jailhouse.gitJailhouse patch：https:&#x2F;&#x2F;github.com&#x2F;rvm-rtos&#x2F;RVM1.5&#x2F;blob&#x2F;main&#x2F;scripts&#x2F;guest&#x2F;jailhouse.patch">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-01-19T06:44:01.000Z">
<meta property="article:modified_time" content="2024-01-20T03:59:45.688Z">
<meta property="article:author" content="Little_Q">
<meta property="article:tag" content="arceos">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://peizhongqiu.github.io/p/30eb7570.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>rvm1.5 | Little Q 的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <!--<div class="headband"></div>-->

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Little Q 的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/30eb7570.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          rvm1.5
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-01-19 14:44:01" itemprop="dateCreated datePublished" datetime="2024-01-19T14:44:01+08:00">2024-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-20 11:59:45" itemprop="dateModified" datetime="2024-01-20T11:59:45+08:00">2024-01-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="源代码仓库"><a href="#源代码仓库" class="headerlink" title="源代码仓库"></a>源代码仓库</h2><p>RVM1.5：<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/tree/main">https://github.com/rvm-rtos/RVM1.5/tree/main</a><br>Jailhouse：<a target="_blank" rel="noopener" href="https://github.com/siemens/jailhouse.git">https://github.com/siemens/jailhouse.git</a><br>Jailhouse patch：<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/jailhouse.patch">https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/jailhouse.patch</a></p>
<span id="more"></span>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><h2 id="源代码阅读"><a href="#源代码阅读" class="headerlink" title="源代码阅读"></a>源代码阅读</h2><h3 id="jailhouse-init"><a href="#jailhouse-init" class="headerlink" title="jailhouse_init"></a>jailhouse_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/main.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">jailhouse_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_KALLSYMS_ALL) &amp;&amp; LINUX_VERSION_CODE &lt; KERNEL_VERSION(5,7,0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RESOLVE_EXTERNAL_SYMBOL(symbol)			\</span></span><br><span class="line"><span class="meta">    <span class="comment">// kallsyms_lookup_name 是 Linux 内核中的一个函数，用于查找与给定符号名称相关联的内核地址。</span></span></span><br><span class="line">	symbol##_sym = (<span class="type">void</span> *)kallsyms_lookup_name(<span class="meta">#symbol);	\</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (!symbol##_sym)					\</span></span><br><span class="line"><span class="meta">		return -EINVAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RESOLVE_EXTERNAL_SYMBOL(symbol)			\</span></span><br><span class="line"><span class="meta">	symbol##_sym = &amp;symbol</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESOLVE_EXTERNAL_SYMBOL(symbol...) __RESOLVE_EXTERNAL_SYMBOL(symbol)</span></span><br><span class="line">    <span class="comment">// ioremap_page_range 是 Linux 内核中的函数，用于将物理地址映射到内核虚拟地址空间的页表中。</span></span><br><span class="line">	RESOLVE_EXTERNAL_SYMBOL(ioremap_page_range);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">    <span class="comment">// lapic_timer_period 通常是指在多处理器系统中的 LAPIC 中定时器的周期。</span></span><br><span class="line">	RESOLVE_EXTERNAL_SYMBOL(lapic_timer_period);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 在 sysfs 中有这样一个目录：/sys/devices，系统中所有的设备，都归集在该目录下。</span></span><br><span class="line">    <span class="comment">// 有些设备，是通过 device_register 注册到 Kernel 并体现在 /sys/devices/xxx/ 下。</span></span><br><span class="line">    <span class="comment">// 但有时候我们仅仅需要在 /sys/devices/ 下注册一个目录，该目录不代表任何的实体设备，这时可以使用 root_device_register 接口。</span></span><br><span class="line">	jailhouse_dev = root_device_register(<span class="string">&quot;jailhouse&quot;</span>);</span><br><span class="line">	...</span><br><span class="line">	err = jailhouse_sysfs_init(jailhouse_dev);</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// misc_register 是 Linux 内核中用于注册杂项字符设备（Miscellaneous Character Device）的函数。</span></span><br><span class="line">    <span class="comment">// Miscellaneous Character Devices 是一类特殊用途的字符设备，通常用于表示不属于其他特定类别（如块设备或网络设备）的小型设备。</span></span><br><span class="line">    <span class="comment">// 通过这样的注册，Linux 内核会在 /dev 目录下创建一个相应的设备文件，用户空间的应用程序可以通过该文件进行与设备的交互。</span></span><br><span class="line">	err = misc_register(&amp;jailhouse_misc_dev);</span><br><span class="line">    ...</span><br><span class="line">	err = jailhouse_pci_register();</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// register_reboot_notifier 是 Linux 内核中用于注册重启通知回调函数的函数。这个函数允许内核模块或子系统在系统即将重启时执行自定义的操作。</span></span><br><span class="line">	register_reboot_notifier(&amp;jailhouse_shutdown_nb);</span><br><span class="line"></span><br><span class="line">	init_hypercall();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/sysfs.c</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> <span class="title">jailhouse_attribute_group</span> =</span> &#123;</span><br><span class="line">	.name = <span class="literal">NULL</span>,</span><br><span class="line">	.attrs = jailhouse_sysfs_entries,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> *<span class="title">jailhouse_sysfs_entries</span>[] =</span> &#123;</span><br><span class="line">	&amp;dev_attr_console.attr,</span><br><span class="line">	&amp;dev_attr_enabled.attr,</span><br><span class="line">	&amp;dev_attr_mem_pool_size.attr,</span><br><span class="line">	&amp;dev_attr_mem_pool_used.attr,</span><br><span class="line">	&amp;dev_attr_remap_pool_size.attr,</span><br><span class="line">	&amp;dev_attr_remap_pool_used.attr,</span><br><span class="line">	<span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_sysfs_init</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = sysfs_create_group(&amp;dev-&gt;kobj, &amp;jailhouse_attribute_group);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	cells_dir = kobject_create_and_add(<span class="string">&quot;cells&quot;</span>, &amp;dev-&gt;kobj);</span><br><span class="line">	<span class="keyword">if</span> (!cells_dir) &#123;</span><br><span class="line">		sysfs_remove_group(&amp;dev-&gt;kobj, &amp;jailhouse_attribute_group);</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sysfs_create_group 是 Linux 内核中用于在 sysfs（系统文件系统）中创建属性组（attribute group）的函数。Sysfs 提供了一种将内核信息以文件和目录的形式暴露给用户空间的机制，而属性组则允许将相关的属性组织在一起。</p>
<p>kobject_create_and_add 是 Linux 内核中用于创建并添加内核对象（kobject）的函数。Sysfs 提供了一种将内核中的对象以文件和目录的形式暴露给用户空间的机制。<br>这样创建的内核对象可以在 sysfs 中表示为一个目录，用户空间可以通过 sysfs 接口访问其中的文件和属性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/pci.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register jailhouse as a PCI device driver so it can claim assigned devices.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 0 on success, or error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_pci_register</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> pci_register_driver(&amp;jailhouse_pci_stub_driver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pci_register_driver 是 Linux 内核中用于注册 PCI 驱动程序的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">init_hypercall</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	jailhouse_use_vmcall = boot_cpu_has(X86_FEATURE_VMX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为默认支持 vmx，所以 jailhouse_use_vmcall 为 true。</p>
<p>这样，初始化的工作就完成了。</p>
<h3 id="jailhouse-ioctl"><a href="#jailhouse-ioctl" class="headerlink" title="jailhouse_ioctl"></a>jailhouse_ioctl</h3><p>jailhouse_ioctl 会根据传递进来的参数，判断调用哪个函数并执行。从这里可以看出，jailhouse 主要的函数有：<br>jailhouse_cmd_enable，jailhouse_cmd_disable，jailhouse_cmd_cell_create，jailhouse_cmd_cell_load，<br>jailhouse_cmd_cell_start，jailhouse_cmd_cell_destroy。</p>
<p>在 jailhouse&#x2F;tools&#x2F;jailhouse.c 中可以看到 jailhouse 的一些使用方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">jailhouse_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> ioctl,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (ioctl) &#123;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_ENABLE:</span><br><span class="line">		err = jailhouse_cmd_enable(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_system __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_DISABLE:</span><br><span class="line">		err = jailhouse_cmd_disable();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_CREATE:</span><br><span class="line">		err = jailhouse_cmd_cell_create(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_cell_create __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_LOAD:</span><br><span class="line">		err = jailhouse_cmd_cell_load(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_cell_load __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_START:</span><br><span class="line">		err = jailhouse_cmd_cell_start((<span class="type">const</span> <span class="type">char</span> __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_DESTROY:</span><br><span class="line">		err = jailhouse_cmd_cell_destroy((<span class="type">const</span> <span class="type">char</span> __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="jailhouse-cmd-enable"><a href="#jailhouse-cmd-enable" class="headerlink" title="jailhouse_cmd_enable"></a>jailhouse_cmd_enable</h3><p>在对代码分析之前，需要看如何使用 enable 功能。查看 RVM1.5 中的 enable-rvm.sh（<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/enable-rvm.sh%EF%BC%89%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%BD%BF%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E4%B8%BA%EF%BC%9A">https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/enable-rvm.sh）文件，可以看到使用的命令为：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JH_DIR=~/jailhouse</span><br><span class="line">JH=$JH_DIR/tools/jailhouse</span><br><span class="line">sudo $JH enable $JH_DIR/configs/x86/qemu-ubuntu.cell</span><br></pre></td></tr></table></figure>
<p>这里面 enable 后面附带一个参数： $JH_DIR&#x2F;configs&#x2F;x86&#x2F;qemu-ubuntu.cell。在 gen-config 中有这么一行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python3 ./tools/jailhouse-config-create --mem-hv 512M ./configs/x86/qemu-ubuntu.c</span><br></pre></td></tr></table></figure>
<p>这个会生成 qemu-ubuntu.c 文件，里面是关于 jailhouse 的一些配置。在后续 make 时，会根据该文件生成对应的 qemu-ubuntu.cell 文件。具体可以查看 jailhouse&#x2F;configs&#x2F;Makefile 文件。</p>
<p>接着，看 jailhouse_cmd_enable 的函数签名：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以看 jailhouse_cmd_enable 的调用路线：enable(argc, argv)(tools&#x2F;jailhouse.c) -&gt; ioctl(fd, JAILHOUSE_ENABLE, config) -&gt; jailhouse_cmd_enable((struct jailhouse_system __user *)arg)。<br>第一个 enable 函数中 argc 和 argv 跟 main 函数的一致。iocal 中的 fd 是打开 jailhouse 的文件描述符。config 是读取 argv 第三个参数所对应的文件内容。最后的 arg 就跟 config 对应。<br>根据以上内容可知，arg 对应的就是 $JH_DIR&#x2F;configs&#x2F;x86&#x2F;qemu-ubuntu.cell 文件的内容，即系统配置文件。</p>
<h4 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h4><p>在开始阅读代码之前，了解 hypervisor image 的内存布局。RVM 1.5 的内存布局如下图所示。</p>


<p>接下来详细分析以下 enable 的全过程。</p>
<h4 id="第一步，将-arg-中的前-sizeof-jailhouse-system-个字节拷贝到-config-header"><a href="#第一步，将-arg-中的前-sizeof-jailhouse-system-个字节拷贝到-config-header" class="headerlink" title="第一步，将 arg 中的前 sizeof(jailhouse_system) 个字节拷贝到 config_header"></a>第一步，将 arg 中的前 sizeof(jailhouse_system) 个字节拷贝到 config_header</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;config_header, arg, <span class="keyword">sizeof</span>(config_header)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">// 检查 config_header.signature 和 config_header.revision</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(config_header.signature, JAILHOUSE_SYSTEM_SIGNATURE,</span><br><span class="line">		   <span class="keyword">sizeof</span>(config_header.signature)) != <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Not a system configuration\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (config_header.revision != JAILHOUSE_CONFIG_REVISION) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Configuration revision mismatch\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	config_header.root_cell.name[JAILHOUSE_CELL_NAME_MAXLEN] = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第二步，上锁，增加模块引用计数，检查-vmx-功能是否打开"><a href="#第二步，上锁，增加模块引用计数，检查-vmx-功能是否打开" class="headerlink" title="第二步，上锁，增加模块引用计数，检查 vmx 功能是否打开"></a>第二步，上锁，增加模块引用计数，检查 vmx 功能是否打开</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// mutex_lock_interruptible 函数是一种获取互斥锁的方式，允许在等待锁的过程中被信号中断。</span></span><br><span class="line">    <span class="comment">// 这样的机制有助于避免在用户空间中调用的操作导致内核中断等待的死锁情况。</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;jailhouse_lock) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line">	err = -EBUSY;</span><br><span class="line">    <span class="comment">// try_module_get(THIS_MODULE) 是 Linux 内核中用于尝试增加模块引用计数的函数。</span></span><br><span class="line">    <span class="comment">// 模块引用计数是跟踪内核模块被使用的计数器，当模块被使用时，引用计数会增加，当不再使用时，引用计数会减少。</span></span><br><span class="line">    <span class="comment">// 引用计数为零时，模块可以被卸载。</span></span><br><span class="line">    <span class="comment">// jailhouse_enabled 代表是否已经启用，所以必须要为 false</span></span><br><span class="line">	<span class="keyword">if</span> (jailhouse_enabled || !try_module_get(THIS_MODULE))</span><br><span class="line">		<span class="keyword">goto</span> error_unlock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">	<span class="keyword">if</span> (boot_cpu_has(X86_FEATURE_VMX)) &#123;</span><br><span class="line">		u64 features;</span><br><span class="line"></span><br><span class="line">		rdmsrl(MSR_IA32_FEAT_CTL, features);</span><br><span class="line">		<span class="keyword">if</span> ((features &amp; FEAT_CTL_VMX_ENABLED_OUTSIDE_SMX) == <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: VT-x disabled by Firmware/BIOS\n&quot;</span>);</span><br><span class="line">			err = -ENODEV;</span><br><span class="line">			<span class="keyword">goto</span> error_put_module;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第三步，加载-hypervisor-镜像"><a href="#第三步，加载-hypervisor-镜像" class="headerlink" title="第三步，加载 hypervisor 镜像"></a>第三步，加载 hypervisor 镜像</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fw_name = jailhouse_get_fw_name();	<span class="comment">// rvm-intel.bin</span></span><br><span class="line">	<span class="keyword">if</span> (!fw_name) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Missing or unsupported HVM technology\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// request_firmware 是用于请求固件文件的函数。它允许内核驱动程序在运行时动态地获取与硬件设备相关的固件信息。</span></span><br><span class="line">	<span class="comment">// 这对于支持一些设备而无需将固件硬编码到内核中的情况非常有用。</span></span><br><span class="line">	<span class="comment">// request_firmware 用于请求名为 &quot;rvm-intel.bin&quot; 的固件文件。</span></span><br><span class="line">	<span class="comment">// 如果请求成功，固件数据将包含在 hypervisor-&gt;data 中，然后你可以在这个数据上执行你的操作。</span></span><br><span class="line">	<span class="comment">// 最后，使用 release_firmware 函数释放固件数据。</span></span><br><span class="line">    err = request_firmware(&amp;hypervisor, fw_name, jailhouse_dev);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Missing hypervisor image %s\n&quot;</span>, fw_name);</span><br><span class="line">		<span class="keyword">goto</span> error_put_module;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 内容在 rvm-intel.bin 中的 .header 节中，具体在 RVM1.5/src/header.rs/HvHeaderStuff 中。</span></span><br><span class="line">	header = (<span class="keyword">struct</span> jailhouse_header *)hypervisor-&gt;data;</span><br><span class="line"></span><br><span class="line">	err = -EINVAL;</span><br><span class="line">    <span class="comment">// 检查签名</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(header-&gt;signature, JAILHOUSE_SIGNATURE,</span><br><span class="line">		   <span class="keyword">sizeof</span>(header-&gt;signature)) != <span class="number">0</span> ||</span><br><span class="line">	    hypervisor-&gt;size &gt;= hv_mem-&gt;size)</span><br><span class="line">		<span class="keyword">goto</span> error_release_fw;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第四步，分配内存，建立虚拟映射，并用-hypervisor-初始化-hypervisor-mem"><a href="#第四步，分配内存，建立虚拟映射，并用-hypervisor-初始化-hypervisor-mem" class="headerlink" title="第四步，分配内存，建立虚拟映射，并用 hypervisor 初始化 hypervisor_mem"></a>第四步，分配内存，建立虚拟映射，并用 hypervisor 初始化 hypervisor_mem</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_memory</span> *<span class="title">hv_mem</span> =</span> &amp;config_header.hypervisor_memory;</span><br><span class="line"></span><br><span class="line">    jailhouse_firmware_free(); <span class="comment">// 释放 hypervisor_mem_res</span></span><br><span class="line"></span><br><span class="line">	hypervisor_mem_res = request_mem_region(hv_mem-&gt;phys_start,</span><br><span class="line">						hv_mem-&gt;size,</span><br><span class="line">						<span class="string">&quot;Jailhouse hypervisor&quot;</span>); <span class="comment">// 分配物理内存</span></span><br><span class="line">	<span class="keyword">if</span> (!hypervisor_mem_res) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: request_mem_region failed for hypervisor &quot;</span></span><br><span class="line">		       <span class="string">&quot;memory.\n&quot;</span>);</span><br><span class="line">		pr_notice(<span class="string">&quot;jailhouse: Did you reserve the memory with &quot;</span></span><br><span class="line">			  <span class="string">&quot;\&quot;memmap=\&quot; or \&quot;mem=\&quot;?\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> error_release_fw;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Map physical memory region reserved for Jailhouse. */</span></span><br><span class="line">	hypervisor_mem = jailhouse_ioremap(hv_mem-&gt;phys_start, remap_addr,</span><br><span class="line">					   hv_mem-&gt;size);	<span class="comment">// 建立虚拟映射</span></span><br><span class="line">	<span class="keyword">if</span> (!hypervisor_mem) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Unable to map RAM reserved for hypervisor &quot;</span></span><br><span class="line">		       <span class="string">&quot;at %08lx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)hv_mem-&gt;phys_start);</span><br><span class="line">		<span class="keyword">goto</span> error_release_memreg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	console_page = (<span class="keyword">struct</span> jailhouse_virt_console*)</span><br><span class="line">		(hypervisor_mem + header-&gt;console_page);</span><br><span class="line">	last_console.valid = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy hypervisor&#x27;s binary image at beginning of the memory region</span></span><br><span class="line"><span class="comment">	 * and clear the rest to zero. */</span></span><br><span class="line">    <span class="comment">// 用 hypervisor 初始化 hypervisor_mem。</span></span><br><span class="line">	<span class="built_in">memcpy</span>(hypervisor_mem, hypervisor-&gt;data, hypervisor-&gt;size);</span><br><span class="line">	<span class="built_in">memset</span>(hypervisor_mem + hypervisor-&gt;size, <span class="number">0</span>,</span><br><span class="line">	       hv_mem-&gt;size - hypervisor-&gt;size);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第五步，完善-hypervisor-mem-数据"><a href="#第五步，完善-hypervisor-mem-数据" class="headerlink" title="第五步，完善 hypervisor_mem 数据"></a>第五步，完善 hypervisor_mem 数据</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    max_cpus = get_max_cpus(config_header.root_cell.cpu_set_size, arg);</span><br><span class="line">    header = (<span class="keyword">struct</span> jailhouse_header *)hypervisor_mem;</span><br><span class="line">	header-&gt;max_cpus = max_cpus;</span><br><span class="line">    <span class="comment">// 在 sysfs 中创建二进制文件。成功创建后，用户空间可以通过文件系统接口来读取该二进制文件。</span></span><br><span class="line">	err = jailhouse_sysfs_core_init(jailhouse_dev, header-&gt;core_size);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ARMv8 requires to clean D-cache and invalidate I-cache for memory</span></span><br><span class="line"><span class="comment">	 * containing new instructions. On x86 this is a NOP. On ARMv7 the</span></span><br><span class="line"><span class="comment">	 * firmware does its own cache maintenance, so it is an</span></span><br><span class="line"><span class="comment">	 * extraneous (but harmless) flush.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	flush_icache_range((<span class="type">unsigned</span> <span class="type">long</span>)hypervisor_mem,</span><br><span class="line">			   (<span class="type">unsigned</span> <span class="type">long</span>)(hypervisor_mem + header-&gt;core_size));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy system configuration to its target address in hypervisor memory</span></span><br><span class="line"><span class="comment">	 * region. */</span></span><br><span class="line">	config = (<span class="keyword">struct</span> jailhouse_system *)</span><br><span class="line">		(hypervisor_mem + hv_core_and_percpu_size);</span><br><span class="line">	<span class="comment">// 将 qemu-ubuntu.c 中的 config 写入 hypervisor_mem 中的 systemconfig 区域</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(config, arg, config_size)) &#123;</span><br><span class="line">		err = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (config-&gt;debug_console.clock_reg) &#123;</span><br><span class="line">		clock_reg = ioremap(config-&gt;debug_console.clock_reg,</span><br><span class="line">				    <span class="keyword">sizeof</span>(clock_gates));</span><br><span class="line">		<span class="keyword">if</span> (!clock_reg) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: Unable to map clock register at &quot;</span></span><br><span class="line">			       <span class="string">&quot;%08lx\n&quot;</span>,</span><br><span class="line">			       (<span class="type">unsigned</span> <span class="type">long</span>)config-&gt;debug_console.clock_reg);</span><br><span class="line">			<span class="keyword">goto</span> error_unmap;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		clock_gates = readl(clock_reg);</span><br><span class="line">		<span class="keyword">if</span> (CON_HAS_INVERTED_GATE(config-&gt;debug_console.flags))</span><br><span class="line">			clock_gates &amp;= ~(<span class="number">1</span> &lt;&lt; config-&gt;debug_console.gate_nr);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			clock_gates |= (<span class="number">1</span> &lt;&lt; config-&gt;debug_console.gate_nr);</span><br><span class="line">		writel(clock_gates, clock_reg);</span><br><span class="line"></span><br><span class="line">		iounmap(clock_reg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> JAILHOUSE_BORROW_ROOT_PT</span></span><br><span class="line">	<span class="keyword">if</span> (CON_IS_MMIO(config-&gt;debug_console.flags)) &#123;</span><br><span class="line">		console = ioremap(config-&gt;debug_console.address,</span><br><span class="line">				  config-&gt;debug_console.size);</span><br><span class="line">		<span class="keyword">if</span> (!console) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: Unable to map hypervisor debug &quot;</span></span><br><span class="line">			       <span class="string">&quot;console at %08lx\n&quot;</span>,</span><br><span class="line">			       (<span class="type">unsigned</span> <span class="type">long</span>)config-&gt;debug_console.address);</span><br><span class="line">			<span class="keyword">goto</span> error_unmap;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* The hypervisor has no notion of address spaces, so we need</span></span><br><span class="line"><span class="comment">		 * to enforce conversion. */</span></span><br><span class="line">		header-&gt;debug_console_base = (<span class="type">void</span> * __force)console;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	console_available = SYS_FLAGS_VIRTUAL_DEBUG_CONSOLE(config-&gt;flags);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">	<span class="keyword">if</span> (config-&gt;platform_info.x86.tsc_khz == <span class="number">0</span>)</span><br><span class="line">		config-&gt;platform_info.x86.tsc_khz = tsc_khz;</span><br><span class="line">	<span class="keyword">if</span> (config-&gt;platform_info.x86.apic_khz == <span class="number">0</span>)</span><br><span class="line">		config-&gt;platform_info.x86.apic_khz =</span><br><span class="line">			*lapic_timer_period_sym / (<span class="number">1000</span> / HZ);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第六步，创建-cell"><a href="#第六步，创建-cell" class="headerlink" title="第六步，创建 cell"></a>第六步，创建 cell</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> cell *<span class="title function_">cell_create</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> jailhouse_cell_desc *cell_desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cell</span> *<span class="title">cell</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> id;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cell_desc-&gt;num_memory_regions &gt;=</span><br><span class="line">	    ULONG_MAX / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* determine cell id */</span></span><br><span class="line">	id = <span class="number">0</span>;</span><br><span class="line">retry:</span><br><span class="line">	list_for_each_entry(cell, &amp;cells, entry)</span><br><span class="line">		<span class="keyword">if</span> (cell-&gt;id == id) &#123;</span><br><span class="line">			id++;</span><br><span class="line">			<span class="keyword">goto</span> retry;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	cell = kzalloc(<span class="keyword">sizeof</span>(*cell), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!cell)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;cell-&gt;entry);</span><br><span class="line">    <span class="comment">// 用 cell_desc 初始化 cell</span></span><br><span class="line">	cell-&gt;id = id;</span><br><span class="line"></span><br><span class="line">	bitmap_copy(cpumask_bits(&amp;cell-&gt;cpus_assigned),</span><br><span class="line">		    jailhouse_cell_cpu_set(cell_desc),</span><br><span class="line">		    min((<span class="type">unsigned</span> <span class="type">int</span>)nr_cpumask_bits,</span><br><span class="line">		        cell_desc-&gt;cpu_set_size * <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">	cell-&gt;num_memory_regions = cell_desc-&gt;num_memory_regions;</span><br><span class="line">	cell-&gt;memory_regions = vmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory) *</span><br><span class="line">				       cell-&gt;num_memory_regions);</span><br><span class="line">	<span class="keyword">if</span> (!cell-&gt;memory_regions) &#123;</span><br><span class="line">		kfree(cell);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(cell-&gt;name, cell_desc-&gt;name, JAILHOUSE_CELL_ID_NAMELEN);</span><br><span class="line">	cell-&gt;name[JAILHOUSE_CELL_ID_NAMELEN] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(cell-&gt;memory_regions, jailhouse_cell_mem_regions(cell_desc),</span><br><span class="line">	       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory) * cell-&gt;num_memory_regions);</span><br><span class="line">    </span><br><span class="line">	err = jailhouse_pci_cell_setup(cell, cell_desc);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		vfree(cell-&gt;memory_regions);</span><br><span class="line">		kfree(cell);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 使用 kobject_init_and_add 初始化和添加内核对象。</span></span><br><span class="line">    <span class="comment">// 成功添加后，用户空间可以通过 sysfs 文件系统接口访问该对象。</span></span><br><span class="line">    <span class="comment">// 然后调用 sysfs_create_group 在 sysfs 中创建属性组。</span></span><br><span class="line">    <span class="comment">// 成功创建后，用户空间可以通过文件系统接口访问该属性组。</span></span><br><span class="line">	err = jailhouse_sysfs_cell_create(cell);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="comment">/* cleanup done by jailhouse_sysfs_cell_create */</span></span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_cell_prepare_root</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> jailhouse_cell_desc *cell_desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	root_cell = cell_create(cell_desc);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(root_cell))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(root_cell);</span><br><span class="line"></span><br><span class="line">	cpumask_and(&amp;root_cell-&gt;cpus_assigned, &amp;root_cell-&gt;cpus_assigned,</span><br><span class="line">		    cpu_online_mask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    err = jailhouse_cell_prepare_root(&amp;config-&gt;root_cell);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第七步，跳转到-RVM1-5-中执行"><a href="#第七步，跳转到-RVM1-5-中执行" class="headerlink" title="第七步，跳转到 RVM1.5 中执行"></a>第七步，跳转到 RVM1.5 中执行</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    preempt_disable();</span><br><span class="line"></span><br><span class="line">	header-&gt;online_cpus = num_online_cpus();</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// on_each_cpu 是 Linux 内核中用于在所有 CPU 上执行指定函数的宏。</span></span><br><span class="line">    <span class="comment">// 该宏的目的是在对称多处理（SMP）系统中并行地执行相同的函数，以便在所有 CPU 上进行某些全局操作。</span></span><br><span class="line">    <span class="comment">// 第一个参数：指向将在每个 CPU 上执行的函数的指针。</span></span><br><span class="line">    <span class="comment">// 第二个参数：传递给 func 函数的额外参数。</span></span><br><span class="line">    <span class="comment">// 第三个参数：指定是否等待所有 CPU 上的函数执行完成。如果为 1，等待；如果为 0，不等待。</span></span><br><span class="line">	on_each_cpu(enter_hypervisor, header, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 等待所有 cpu 完成</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called for each cpu by the JAILHOUSE_ENABLE ioctl.</span></span><br><span class="line"><span class="comment"> * It jumps to the entry point set in the header, reports the result and</span></span><br><span class="line"><span class="comment"> * signals completion to the main thread that invoked it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">enter_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_header</span> *<span class="title">header</span> =</span> info;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu = smp_processor_id();</span><br><span class="line">	<span class="type">int</span> (*entry)(<span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">    <span class="comment">// 查看 RVM1.5/linker.lds，__entry_offset = arch_entry - BASE_ADDRESS;</span></span><br><span class="line">	entry = header-&gt;entry + (<span class="type">unsigned</span> <span class="type">long</span>) hypervisor_mem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpu &lt; header-&gt;max_cpus)</span><br><span class="line">		<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">        <span class="comment">// 进入 RVM1.5 执行</span></span><br><span class="line">		err = entry(cpu);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		err = -EINVAL;</span><br><span class="line">    <span class="comment">// 此时，已经进入 guest 状态执行</span></span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now on - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第八步，进入-RVM-1-5，从-arch-entry-到-main-函数"><a href="#第八步，进入-RVM-1-5，从-arch-entry-到-main-函数" class="headerlink" title="第八步，进入 RVM 1.5，从 arch_entry 到 main 函数"></a>第八步，进入 RVM 1.5，从 arch_entry 到 main 函数</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">arch_entry</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    core::arch::asm!(<span class="string">&quot;</span></span><br><span class="line"><span class="string">        // rip is pushed</span></span><br><span class="line"><span class="string">        cli</span></span><br><span class="line"><span class="string">        push rbp</span></span><br><span class="line"><span class="string">        push rbx</span></span><br><span class="line"><span class="string">        push r12</span></span><br><span class="line"><span class="string">        push r13</span></span><br><span class="line"><span class="string">        push r14</span></span><br><span class="line"><span class="string">        push r15</span></span><br><span class="line"><span class="string">        push 0  // skip gs_base</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rdi, rsp    // switch_stack 参数为此时的栈指针</span></span><br><span class="line"><span class="string">        call &#123;0&#125; // 调用 switch_stack</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        pop r15 // skip gs_base</span></span><br><span class="line"><span class="string">        pop r15</span></span><br><span class="line"><span class="string">        pop r14</span></span><br><span class="line"><span class="string">        pop r13</span></span><br><span class="line"><span class="string">        pop r12</span></span><br><span class="line"><span class="string">        pop rbx</span></span><br><span class="line"><span class="string">        pop rbp</span></span><br><span class="line"><span class="string">        ret</span></span><br><span class="line"><span class="string">        // rip will pop when return&quot;</span>,</span><br><span class="line">        sym switch_stack,</span><br><span class="line">        <span class="title function_ invoke__">options</span>(noreturn),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// extern &quot;sysv64&quot; 通过 FFI 调用 非Windows x86_64 平台下的 C 资源所使用的默认调用约定。</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">&quot;sysv64&quot;</span> <span class="keyword">fn</span> <span class="title function_">switch_stack</span>(linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">linux_tp</span> = Msr::IA32_GS_BASE.<span class="title function_ invoke__">read</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpu_data</span> = <span class="keyword">match</span> PerCpu::<span class="title function_ invoke__">new</span>() &#123;    <span class="comment">// 初始化 cpu_data</span></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(c) =&gt; c,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> e.<span class="title function_ invoke__">code</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">hv_sp</span> = cpu_data.<span class="title function_ invoke__">stack_top</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ret</span>;</span><br><span class="line">    core::arch::asm!(<span class="string">&quot;</span></span><br><span class="line"><span class="string">        mov [rsi], &#123;linux_tp&#125;   // save gs_base to stack</span></span><br><span class="line"><span class="string">        mov rcx, rsp            // 保存 rsp</span></span><br><span class="line"><span class="string">        mov rsp, &#123;hv_sp&#125;        // 更换 rsp</span></span><br><span class="line"><span class="string">        push rcx</span></span><br><span class="line"><span class="string">        call &#123;entry&#125;</span></span><br><span class="line"><span class="string">        pop rsp&quot;</span>,</span><br><span class="line">        entry = sym crate::entry,</span><br><span class="line">        linux_tp = <span class="title function_ invoke__">in</span>(reg) linux_tp,</span><br><span class="line">        hv_sp = <span class="title function_ invoke__">in</span>(reg) hv_sp,</span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdi&quot;</span>) cpu_data, <span class="comment">// entry 第一个参数</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rsi&quot;</span>) linux_sp, <span class="comment">// entry 第二个参数</span></span><br><span class="line">        <span class="title function_ invoke__">lateout</span>(<span class="string">&quot;rax&quot;</span>) ret, <span class="comment">// rax 为返回值，为 ret</span></span><br><span class="line">        <span class="title function_ invoke__">out</span>(<span class="string">&quot;rcx&quot;</span>) _,</span><br><span class="line">    );</span><br><span class="line">    Msr::IA32_GS_BASE.<span class="title function_ invoke__">write</span>(linux_tp);</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;sysv64&quot;</span> <span class="keyword">fn</span> <span class="title function_">entry</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="title function_ invoke__">main</span>(cpu_data, linux_sp) &#123;</span><br><span class="line">        error!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, e);</span><br><span class="line">        ERROR_NUM.<span class="title function_ invoke__">store</span>(e.<span class="title function_ invoke__">code</span>(), Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">code</span> = ERROR_NUM.<span class="title function_ invoke__">load</span>(Ordering::Acquire);</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">&quot;CPU &#123;&#125; return back to driver with code &#123;&#125;.&quot;</span>,</span><br><span class="line">        cpu_data.id, code</span><br><span class="line">    );</span><br><span class="line">    code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第九步，primary-init-early"><a href="#第九步，primary-init-early" class="headerlink" title="第九步，primary_init_early"></a>第九步，primary_init_early</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="comment">// 此时 cpu_data 状态为：state 为 HvDisabled，LinuxContext 为空</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_primary</span> = cpu_data.id == <span class="number">0</span>;  <span class="comment">// primary cpu</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">online_cpus</span> = HvHeader::<span class="title function_ invoke__">get</span>().online_cpus; <span class="comment">//HvHeaderStuff 的数据</span></span><br><span class="line">    <span class="title function_ invoke__">wait_for</span>(|| PerCpu::<span class="title function_ invoke__">entered_cpus</span>() &lt; online_cpus)?; <span class="comment">// 同步</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_primary &#123;</span><br><span class="line">        <span class="title function_ invoke__">primary_init_early</span>()?;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 等待 primary_init_early 完成</span></span><br><span class="line">        <span class="title function_ invoke__">wait_for_counter</span>(&amp;INIT_EARLY_OK, <span class="number">1</span>)?    </span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">primary_init_early</span>() <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    logging::<span class="title function_ invoke__">init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">system_config</span> = HvSystemConfig::<span class="title function_ invoke__">get</span>();  <span class="comment">// 获取 system_config</span></span><br><span class="line"></span><br><span class="line">    memory::<span class="title function_ invoke__">init_heap</span>();    <span class="comment">// 分配一段 32 MB 内存，初始化 PHYS_VIRT_OFFSET</span></span><br><span class="line">    system_config.<span class="title function_ invoke__">check</span>()?; <span class="comment">// 检查 signature 和 revision</span></span><br><span class="line"></span><br><span class="line">    memory::<span class="title function_ invoke__">init_frame_allocator</span>(); <span class="comment">// 初始化物理内存分配器</span></span><br><span class="line">    memory::<span class="title function_ invoke__">init_hv_page_table</span>()?;  <span class="comment">// 初始化 HV_PT，hypervisor 用的页表</span></span><br><span class="line">    cell::<span class="title function_ invoke__">init</span>()?;  <span class="comment">// 初始化 ROOT_CELL，包括页表和 CellConfig</span></span><br><span class="line"></span><br><span class="line">    INIT_EARLY_OK.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十步，更新-cpu-data"><a href="#第十步，更新-cpu-data" class="headerlink" title="第十步，更新 cpu_data"></a>第十步，更新 cpu_data</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    cpu_data.<span class="title function_ invoke__">init</span>(linux_sp, cell::<span class="title function_ invoke__">root_cell</span>())?;    <span class="comment">// 初始化 Vcpu，state，linux</span></span><br><span class="line">    INITED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">    <span class="title function_ invoke__">wait_for_counter</span>(&amp;INITED_CPUS, online_cpus)?;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux_sp: <span class="type">usize</span>, cell: &amp;Cell) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="comment">// Save CPU state used for linux.</span></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvDisabled;</span><br><span class="line">        <span class="keyword">self</span>.linux = LinuxContext::<span class="title function_ invoke__">load_from</span>(linux_sp);</span><br><span class="line">        <span class="keyword">self</span>.arch.<span class="title function_ invoke__">init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Activate hypervisor page table on each cpu.</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; crate::memory::<span class="title function_ invoke__">hv_page_table</span>().<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">activate</span>() &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize vCPU. Use `ptr::write()` to avoid dropping</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::ptr::<span class="title function_ invoke__">write</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vcpu, Vcpu::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.linux, cell)?) &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvEnabled;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LinuxContext</span> &#123;</span><br><span class="line">    <span class="comment">/// Load linux callee-saved registers from the stack, and other system registers.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_from</span>(linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// 注意，这里的 linux_sp 为更换栈之前的栈指针</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts</span>(linux_sp <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u64</span>, SAVED_LINUX_REGS) &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">gdt</span> = GdtStruct::<span class="title function_ invoke__">sgdt</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">fs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">fs</span>(), &amp;gdt);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">gs</span>(), &amp;gdt);</span><br><span class="line">        fs.base = Msr::IA32_FS_BASE.<span class="title function_ invoke__">read</span>();</span><br><span class="line">        gs.base = regs[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="comment">// 注意，这里的 rsp 并不是直接等于 linux_sp，而是 regs 末尾，相当于 linux_sp 对应的栈中 r15 到 rip 全出栈</span></span><br><span class="line">            rsp: regs.<span class="title function_ invoke__">as_ptr_range</span>().end <span class="keyword">as</span> _,  </span><br><span class="line">            r15: regs[<span class="number">1</span>],</span><br><span class="line">            r14: regs[<span class="number">2</span>],</span><br><span class="line">            r13: regs[<span class="number">3</span>],</span><br><span class="line">            r12: regs[<span class="number">4</span>],</span><br><span class="line">            rbx: regs[<span class="number">5</span>],</span><br><span class="line">            rbp: regs[<span class="number">6</span>],</span><br><span class="line">            <span class="comment">// 进入 arch_entry 前，要把返回地址压栈，所以 rip 中保存的应该是 enter_hypervisor 中 entry(cpu) 的下一条指令。</span></span><br><span class="line">            rip: regs[<span class="number">7</span>],</span><br><span class="line">            es: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">es</span>(), &amp;gdt),</span><br><span class="line">            cs: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">cs</span>(), &amp;gdt),</span><br><span class="line">            ss: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">ss</span>(), &amp;gdt),</span><br><span class="line">            ds: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">ds</span>(), &amp;gdt),</span><br><span class="line">            fs,</span><br><span class="line">            gs,</span><br><span class="line">            tss: Segment::<span class="title function_ invoke__">from_selector</span>(<span class="keyword">unsafe</span> &#123; task::<span class="title function_ invoke__">tr</span>() &#125;, &amp;gdt),</span><br><span class="line">            gdt,</span><br><span class="line">            idt: IdtStruct::<span class="title function_ invoke__">sidt</span>(),</span><br><span class="line">            cr0: Cr0::<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            cr3: Cr3::<span class="title function_ invoke__">read</span>().<span class="number">0</span>.<span class="title function_ invoke__">start_address</span>().<span class="title function_ invoke__">as_u64</span>(),</span><br><span class="line">            cr4: Cr4::<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            efer: Msr::IA32_EFER.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            star: Msr::IA32_STAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            lstar: Msr::IA32_LSTAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            cstar: Msr::IA32_CSTAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            fmask: Msr::IA32_FMASK.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            kernel_gsbase: Msr::IA32_KERNEL_GSBASE.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            pat: Msr::IA32_PAT.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            mtrr_def_type: Msr::IA32_MTRR_DEF_TYPE.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十一步，activate-vmm"><a href="#第十一步，activate-vmm" class="headerlink" title="第十一步，activate_vmm"></a>第十一步，activate_vmm</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="keyword">if</span> is_primary &#123; </span><br><span class="line">        <span class="title function_ invoke__">primary_init_late</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 等待 primary_init_late 完成</span></span><br><span class="line">        <span class="title function_ invoke__">wait_for_counter</span>(&amp;INIT_LATE_OK, <span class="number">1</span>)?</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cpu_data.<span class="title function_ invoke__">activate_vmm</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">activate_vmm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Activating hypervisor on CPU &#123;&#125;...&quot;</span>, <span class="keyword">self</span>.id);</span><br><span class="line">        ACTIVATED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">enter</span>(&amp;<span class="keyword">self</span>.linux)?;</span><br><span class="line">        <span class="built_in">unreachable!</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Vcpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">enter</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux: &amp;LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">regs_mut</span>();</span><br><span class="line">        regs.rax = <span class="number">0</span>;</span><br><span class="line">        regs.rbx = linux.rbx;</span><br><span class="line">        regs.rbp = linux.rbp;</span><br><span class="line">        regs.r12 = linux.r12;</span><br><span class="line">        regs.r13 = linux.r13;</span><br><span class="line">        regs.r14 = linux.r14;</span><br><span class="line">        regs.r15 = linux.r15;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            asm!(</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;0&#125;&quot;</span>,</span><br><span class="line">                restore_regs_from_stack!(),</span><br><span class="line">                <span class="string">&quot;vmlaunch&quot;</span>, <span class="comment">// 进入 guest 执行，执行的地址为前面加载的 rip</span></span><br><span class="line">                <span class="title function_ invoke__">in</span>(reg) regs <span class="keyword">as</span> * <span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Never return if successful</span></span><br><span class="line">        error!(</span><br><span class="line">            <span class="string">&quot;Activate hypervisor failed: &#123;:?&#125;&quot;</span>,</span><br><span class="line">            Vmcs::<span class="title function_ invoke__">instruction_error</span>()</span><br><span class="line">        );</span><br><span class="line">        hv_result_err!(EIO)</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十二步，guest-运行"><a href="#第十二步，guest-运行" class="headerlink" title="第十二步，guest 运行"></a>第十二步，guest 运行</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">enter_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_header</span> *<span class="title">header</span> =</span> info;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu = smp_processor_id();</span><br><span class="line">	<span class="type">int</span> (*entry)(<span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	entry = header-&gt;entry + (<span class="type">unsigned</span> <span class="type">long</span>) hypervisor_mem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpu &lt; header-&gt;max_cpus)</span><br><span class="line">		<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">		err = entry(cpu);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		err = -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)    <span class="comment">// guest 运行的第一条指令</span></span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now on - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    preempt_disable();</span><br><span class="line"></span><br><span class="line">	header-&gt;online_cpus = num_online_cpus();</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">	on_each_cpu(enter_hypervisor, header, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (error_code) &#123;</span><br><span class="line">		err = error_code;</span><br><span class="line">		<span class="keyword">goto</span> error_free_cell;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 现在处于 guest 中，把不必要的资源关闭</span></span><br><span class="line">	<span class="keyword">if</span> (console)</span><br><span class="line">		iounmap(console);</span><br><span class="line"></span><br><span class="line">	release_firmware(hypervisor);</span><br><span class="line">    <span class="comment">// 注册一个 cellid 为 0 的 cell</span></span><br><span class="line">	jailhouse_cell_register_root();</span><br><span class="line">    <span class="comment">// 增加 PCI 设备</span></span><br><span class="line">	jailhouse_pci_virtual_root_devices_add(&amp;config_header);</span><br><span class="line"></span><br><span class="line">	jailhouse_enabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;jailhouse_lock);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;The Jailhouse is opening.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jailhouse-cmd-disable"><a href="#jailhouse-cmd-disable" class="headerlink" title="jailhouse_cmd_disable"></a>jailhouse_cmd_disable</h3><h4 id="jailhouse-部分"><a href="#jailhouse-部分" class="headerlink" title="jailhouse 部分"></a>jailhouse 部分</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_disable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">    <span class="comment">// 上锁</span></span><br><span class="line">	<span class="keyword">if</span> (mutex_lock_interruptible(&amp;jailhouse_lock) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line">    <span class="comment">// jailhouse_enabled 要为 true</span></span><br><span class="line">	<span class="keyword">if</span> (!jailhouse_enabled) &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 回收 jailhouse 相关资源 </span></span><br><span class="line">	err = jailhouse_cmd_cell_destroy_non_root();</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line"></span><br><span class="line">	jailhouse_pci_virtual_root_devices_remove();</span><br><span class="line"></span><br><span class="line">	error_code = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	preempt_disable();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (num_online_cpus() != cpumask_weight(&amp;root_cell-&gt;cpus_assigned)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Not all assigned CPUs are currently online. If we disable</span></span><br><span class="line"><span class="comment">		 * now, we will lose the offlined ones.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line"></span><br><span class="line">		preempt_enable();</span><br><span class="line"></span><br><span class="line">		err = -EBUSY;</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">	on_each_cpu(leave_hypervisor, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line"></span><br><span class="line">	err = error_code;</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;jailhouse: Failed to disable hypervisor: %d\n&quot;</span>, err);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jailhouse_cell_delete_root();</span><br><span class="line">	jailhouse_enabled = <span class="literal">false</span>;</span><br><span class="line">	module_put(THIS_MODULE);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;The Jailhouse was closed.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">unlock_out:</span><br><span class="line">	mutex_unlock(&amp;jailhouse_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">leave_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> *page;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Touch each hypervisor page we may need during the switch so that</span></span><br><span class="line"><span class="comment">	 * the active mm definitely contains all mappings. At least x86 does</span></span><br><span class="line"><span class="comment">	 * not support taking any faults while switching worlds. */</span></span><br><span class="line">	<span class="keyword">for</span> (page = hypervisor_mem;</span><br><span class="line">	     page &lt; hypervisor_mem + hv_core_and_percpu_size;</span><br><span class="line">	     page += PAGE_SIZE)</span><br><span class="line">		readl((<span class="type">void</span> __iomem *)page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">	err = jailhouse_call(JAILHOUSE_HC_DISABLE);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now off - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_CODE	\</span></span><br><span class="line"><span class="meta">	<span class="string">&quot;cmpb $0x01, %[use_vmcall]\n\t&quot;</span>\    <span class="comment">// 判断 jailhouse_use_vmcall 是否为 1</span></span></span><br><span class="line">	<span class="string">&quot;jne 1f\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;vmcall\n\t&quot;</span>\                       <span class="comment">// 触发 vmexit</span></span><br><span class="line">	<span class="string">&quot;jmp 2f\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;1: vmmcall\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;2:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_RESULT	<span class="string">&quot;=a&quot;</span> (result)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_USE_VMCALL	[use_vmcall] <span class="string">&quot;m&quot;</span> (jailhouse_use_vmcall)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_NUM	<span class="string">&quot;a&quot;</span> (num)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u32 <span class="title function_">jailhouse_call</span><span class="params">(__u32 num)</span></span><br><span class="line">&#123;</span><br><span class="line">	__u32 result;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(JAILHOUSE_CALL_CODE</span></span><br><span class="line"><span class="params">		: JAILHOUSE_CALL_RESULT</span></span><br><span class="line"><span class="params">		: JAILHOUSE_USE_VMCALL, JAILHOUSE_CALL_NUM</span></span><br><span class="line"><span class="params">		: <span class="string">&quot;memory&quot;</span>)</span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RVM1-5-部分"><a href="#RVM1-5-部分" class="headerlink" title="RVM1.5 部分"></a>RVM1.5 部分</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">VmExit</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">handle_exit</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">match</span> exit_info.exit_reason &#123;</span><br><span class="line">            VmxExitReason::EXCEPTION_NMI =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_exception_nmi</span>(&amp;exit_info),</span><br><span class="line">            VmxExitReason::CPUID =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_cpuid</span>(),</span><br><span class="line">            VmxExitReason::VMCALL =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_hypercall</span>(),   <span class="comment">// vmcall 触发</span></span><br><span class="line">            VmxExitReason::MSR_READ =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_msr_read</span>(),</span><br><span class="line">            VmxExitReason::MSR_WRITE =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_msr_write</span>(),</span><br><span class="line">            VmxExitReason::EPT_VIOLATION =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_ept_violation</span>(&amp;exit_info),</span><br><span class="line">            VmxExitReason::TRIPLE_FAULT =&gt; &#123;</span><br><span class="line">                error!(<span class="string">&quot;Triple fault: &#123;:#x?&#125;&quot;</span>, exit_info);</span><br><span class="line">                <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">inject_fault</span>()?;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; hv_result_err!(ENOSYS),</span><br><span class="line">        &#125;;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">handle_hypercall</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">use</span> crate::hypercall::HyperCall;</span><br><span class="line">        <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">advance_rip</span>(VM_EXIT_LEN_HYPERCALL)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">guest_regs</span> = <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">regs</span>();</span><br><span class="line">        <span class="keyword">let</span> (code, arg0, arg1) = (guest_regs.rax, guest_regs.rdi, guest_regs.rsi);</span><br><span class="line">        HyperCall::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.cpu_data).<span class="title function_ invoke__">hypercall</span>(code <span class="keyword">as</span> _, arg0, arg1)?;    <span class="comment">// 调用 hypercall</span></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>&gt; HyperCall&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hypercall</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, code: <span class="type">u32</span>, arg0: <span class="type">u64</span>, _arg1: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ret</span> = <span class="keyword">match</span> code &#123;</span><br><span class="line">            HyperCallCode::HypervisorDisable =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">hypervisor_disable</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">hypervisor_disable</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HyperCallResult &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpus</span> = PerCpu::<span class="title function_ invoke__">activated_cpus</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> TRY_DISABLE_CPUS: AtomicU32 = AtomicU32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line">        TRY_DISABLE_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">        <span class="keyword">while</span> TRY_DISABLE_CPUS.<span class="title function_ invoke__">load</span>(Ordering::Acquire) &lt; cpus &#123;</span><br><span class="line">            core::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.cpu_data.<span class="title function_ invoke__">deactivate_vmm</span>(<span class="number">0</span>)?;   <span class="comment">// 关闭 vmm</span></span><br><span class="line">        <span class="built_in">unreachable!</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">deactivate_vmm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ret_code: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Deactivating hypervisor on CPU &#123;&#125;...&quot;</span>, <span class="keyword">self</span>.id);</span><br><span class="line">        ACTIVATED_CPUS.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">set_return_val</span>(ret_code);</span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">exit</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.linux)?;</span><br><span class="line">        <span class="keyword">self</span>.linux.<span class="title function_ invoke__">restore</span>();   <span class="comment">// 用 self.linux 恢复系统寄存器</span></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvDisabled;</span><br><span class="line">        <span class="keyword">self</span>.linux.<span class="title function_ invoke__">return_to_linux</span>(<span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">regs</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Vcpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">exit</span>(&amp;<span class="keyword">self</span>, linux: &amp;<span class="keyword">mut</span> LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">load_vmcs_guest</span>(linux)?;   <span class="comment">// 保存 guest 的状态到 linux</span></span><br><span class="line">        Vmcs::<span class="title function_ invoke__">clear</span>(<span class="keyword">self</span>.vmcs_region.<span class="title function_ invoke__">paddr</span>())?;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; vmx::<span class="title function_ invoke__">vmxoff</span>()? &#125;;</span><br><span class="line">        info!(<span class="string">&quot;successed to turn off VMX.&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LinuxContext</span> &#123;</span><br><span class="line">    <span class="comment">/// Restore linux general-purpose registers and stack, then return back to linux.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">return_to_linux</span>(&amp;<span class="keyword">self</span>, guest_regs: &amp;GeneralRegisters) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">        <span class="comment">// 用 guest 状态恢复 linux，栈换成 linux_rsp，跳转到 linux_rip 执行</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            Msr::IA32_GS_BASE.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.gs.base);</span><br><span class="line">            core::arch::asm!(</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;linux_rsp&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;push &#123;linux_rip&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov rcx, rsp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;guest_regs&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov [rsp + &#123;guest_regs_size&#125;], rcx&quot;</span>,</span><br><span class="line">                restore_regs_from_stack!(),</span><br><span class="line">                <span class="string">&quot;pop rsp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ret&quot;</span>,</span><br><span class="line">                linux_rsp = <span class="title function_ invoke__">in</span>(reg) <span class="keyword">self</span>.rsp,</span><br><span class="line">                linux_rip = <span class="title function_ invoke__">in</span>(reg) <span class="keyword">self</span>.rip,</span><br><span class="line">                guest_regs = <span class="title function_ invoke__">in</span>(reg) guest_regs,</span><br><span class="line">                guest_regs_size = <span class="keyword">const</span> core::mem::size_of::&lt;GeneralRegisters&gt;(),</span><br><span class="line">                <span class="title function_ invoke__">options</span>(noreturn),</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Little_Q
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://peizhongqiu.github.io/p/30eb7570.html" title="rvm1.5">https://peizhongqiu.github.io/p/30eb7570.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/arceos/" rel="tag"># arceos</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/p/af2a573a.html" rel="prev" title="arceos 之 hypervisor-x86 源码阅读">
      <i class="fa fa-chevron-left"></i> arceos 之 hypervisor-x86 源码阅读
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="nav-number">1.</span> <span class="nav-text">源代码仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-number">3.</span> <span class="nav-text">源代码阅读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jailhouse-init"><span class="nav-number">3.1.</span> <span class="nav-text">jailhouse_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jailhouse-ioctl"><span class="nav-number">3.2.</span> <span class="nav-text">jailhouse_ioctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jailhouse-cmd-enable"><span class="nav-number">3.3.</span> <span class="nav-text">jailhouse_cmd_enable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-number">3.3.1.</span> <span class="nav-text">内存布局</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E5%B0%86-arg-%E4%B8%AD%E7%9A%84%E5%89%8D-sizeof-jailhouse-system-%E4%B8%AA%E5%AD%97%E8%8A%82%E6%8B%B7%E8%B4%9D%E5%88%B0-config-header"><span class="nav-number">3.3.2.</span> <span class="nav-text">第一步，将 arg 中的前 sizeof(jailhouse_system) 个字节拷贝到 config_header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E4%B8%8A%E9%94%81%EF%BC%8C%E5%A2%9E%E5%8A%A0%E6%A8%A1%E5%9D%97%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%EF%BC%8C%E6%A3%80%E6%9F%A5-vmx-%E5%8A%9F%E8%83%BD%E6%98%AF%E5%90%A6%E6%89%93%E5%BC%80"><span class="nav-number">3.3.3.</span> <span class="nav-text">第二步，上锁，增加模块引用计数，检查 vmx 功能是否打开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E5%8A%A0%E8%BD%BD-hypervisor-%E9%95%9C%E5%83%8F"><span class="nav-number">3.3.4.</span> <span class="nav-text">第三步，加载 hypervisor 镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%8C%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%EF%BC%8C%E5%BB%BA%E7%AB%8B%E8%99%9A%E6%8B%9F%E6%98%A0%E5%B0%84%EF%BC%8C%E5%B9%B6%E7%94%A8-hypervisor-%E5%88%9D%E5%A7%8B%E5%8C%96-hypervisor-mem"><span class="nav-number">3.3.5.</span> <span class="nav-text">第四步，分配内存，建立虚拟映射，并用 hypervisor 初始化 hypervisor_mem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%8C%E5%AE%8C%E5%96%84-hypervisor-mem-%E6%95%B0%E6%8D%AE"><span class="nav-number">3.3.6.</span> <span class="nav-text">第五步，完善 hypervisor_mem 数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%8C%E5%88%9B%E5%BB%BA-cell"><span class="nav-number">3.3.7.</span> <span class="nav-text">第六步，创建 cell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%8C%E8%B7%B3%E8%BD%AC%E5%88%B0-RVM1-5-%E4%B8%AD%E6%89%A7%E8%A1%8C"><span class="nav-number">3.3.8.</span> <span class="nav-text">第七步，跳转到 RVM1.5 中执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%8C%E8%BF%9B%E5%85%A5-RVM-1-5%EF%BC%8C%E4%BB%8E-arch-entry-%E5%88%B0-main-%E5%87%BD%E6%95%B0"><span class="nav-number">3.3.9.</span> <span class="nav-text">第八步，进入 RVM 1.5，从 arch_entry 到 main 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E6%AD%A5%EF%BC%8Cprimary-init-early"><span class="nav-number">3.3.10.</span> <span class="nav-text">第九步，primary_init_early</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E6%AD%A5%EF%BC%8C%E6%9B%B4%E6%96%B0-cpu-data"><span class="nav-number">3.3.11.</span> <span class="nav-text">第十步，更新 cpu_data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E6%AD%A5%EF%BC%8Cactivate-vmm"><span class="nav-number">3.3.12.</span> <span class="nav-text">第十一步，activate_vmm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E6%AD%A5%EF%BC%8Cguest-%E8%BF%90%E8%A1%8C"><span class="nav-number">3.3.13.</span> <span class="nav-text">第十二步，guest 运行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jailhouse-cmd-disable"><span class="nav-number">3.4.</span> <span class="nav-text">jailhouse_cmd_disable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jailhouse-%E9%83%A8%E5%88%86"><span class="nav-number">3.4.1.</span> <span class="nav-text">jailhouse 部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RVM1-5-%E9%83%A8%E5%88%86"><span class="nav-number">3.4.2.</span> <span class="nav-text">RVM1.5 部分</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Little_Q"
      src="/images/lulu.jpg">
  <p class="site-author-name" itemprop="name">Little_Q</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/PeizhongQiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PeizhongQiu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Little_Q</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
