<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"peizhongqiu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Little Q 的个人博客">
<meta property="og:url" content="https://peizhongqiu.github.io/index.html">
<meta property="og:site_name" content="Little Q 的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Little_Q">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://peizhongqiu.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Little Q 的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <!--<div class="headband"></div>-->

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Little Q 的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/30eb7570.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/30eb7570.html" class="post-title-link" itemprop="url">rvm1.5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-01-19 14:44:01 / 修改时间：23:56:13" itemprop="dateCreated datePublished" datetime="2024-01-19T14:44:01+08:00">2024-01-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="源代码仓库"><a href="#源代码仓库" class="headerlink" title="源代码仓库"></a>源代码仓库</h2><p>RVM1.5：<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/tree/main">https://github.com/rvm-rtos/RVM1.5/tree/main</a><br>Jailhouse：<a target="_blank" rel="noopener" href="https://github.com/siemens/jailhouse.git">https://github.com/siemens/jailhouse.git</a><br>Jailhouse patch：<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/jailhouse.patch">https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/jailhouse.patch</a></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><h2 id="源代码阅读"><a href="#源代码阅读" class="headerlink" title="源代码阅读"></a>源代码阅读</h2><h3 id="jailhouse-init"><a href="#jailhouse-init" class="headerlink" title="jailhouse_init"></a>jailhouse_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/main.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">jailhouse_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_KALLSYMS_ALL) &amp;&amp; LINUX_VERSION_CODE &lt; KERNEL_VERSION(5,7,0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RESOLVE_EXTERNAL_SYMBOL(symbol)			\</span></span><br><span class="line"><span class="meta">    <span class="comment">// kallsyms_lookup_name 是 Linux 内核中的一个函数，用于查找与给定符号名称相关联的内核地址。</span></span></span><br><span class="line">	symbol##_sym = (<span class="type">void</span> *)kallsyms_lookup_name(<span class="meta">#symbol);	\</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (!symbol##_sym)					\</span></span><br><span class="line"><span class="meta">		return -EINVAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RESOLVE_EXTERNAL_SYMBOL(symbol)			\</span></span><br><span class="line"><span class="meta">	symbol##_sym = &amp;symbol</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESOLVE_EXTERNAL_SYMBOL(symbol...) __RESOLVE_EXTERNAL_SYMBOL(symbol)</span></span><br><span class="line">    <span class="comment">// ioremap_page_range 是 Linux 内核中的函数，用于将物理地址映射到内核虚拟地址空间的页表中。</span></span><br><span class="line">	RESOLVE_EXTERNAL_SYMBOL(ioremap_page_range);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">    <span class="comment">// lapic_timer_period 通常是指在多处理器系统中的 LAPIC 中定时器的周期。</span></span><br><span class="line">	RESOLVE_EXTERNAL_SYMBOL(lapic_timer_period);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 在 sysfs 中有这样一个目录：/sys/devices，系统中所有的设备，都归集在该目录下。</span></span><br><span class="line">    <span class="comment">// 有些设备，是通过 device_register 注册到 Kernel 并体现在 /sys/devices/xxx/ 下。</span></span><br><span class="line">    <span class="comment">// 但有时候我们仅仅需要在 /sys/devices/ 下注册一个目录，该目录不代表任何的实体设备，这时可以使用 root_device_register 接口。</span></span><br><span class="line">	jailhouse_dev = root_device_register(<span class="string">&quot;jailhouse&quot;</span>);</span><br><span class="line">	...</span><br><span class="line">	err = jailhouse_sysfs_init(jailhouse_dev);</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// misc_register 是 Linux 内核中用于注册杂项字符设备（Miscellaneous Character Device）的函数。</span></span><br><span class="line">    <span class="comment">// Miscellaneous Character Devices 是一类特殊用途的字符设备，通常用于表示不属于其他特定类别（如块设备或网络设备）的小型设备。</span></span><br><span class="line">    <span class="comment">// 通过这样的注册，Linux 内核会在 /dev 目录下创建一个相应的设备文件，用户空间的应用程序可以通过该文件进行与设备的交互。</span></span><br><span class="line">	err = misc_register(&amp;jailhouse_misc_dev);</span><br><span class="line">    ...</span><br><span class="line">	err = jailhouse_pci_register();</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// register_reboot_notifier 是 Linux 内核中用于注册重启通知回调函数的函数。这个函数允许内核模块或子系统在系统即将重启时执行自定义的操作。</span></span><br><span class="line">	register_reboot_notifier(&amp;jailhouse_shutdown_nb);</span><br><span class="line"></span><br><span class="line">	init_hypercall();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/sysfs.c</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> <span class="title">jailhouse_attribute_group</span> =</span> &#123;</span><br><span class="line">	.name = <span class="literal">NULL</span>,</span><br><span class="line">	.attrs = jailhouse_sysfs_entries,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> *<span class="title">jailhouse_sysfs_entries</span>[] =</span> &#123;</span><br><span class="line">	&amp;dev_attr_console.attr,</span><br><span class="line">	&amp;dev_attr_enabled.attr,</span><br><span class="line">	&amp;dev_attr_mem_pool_size.attr,</span><br><span class="line">	&amp;dev_attr_mem_pool_used.attr,</span><br><span class="line">	&amp;dev_attr_remap_pool_size.attr,</span><br><span class="line">	&amp;dev_attr_remap_pool_used.attr,</span><br><span class="line">	<span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_sysfs_init</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = sysfs_create_group(&amp;dev-&gt;kobj, &amp;jailhouse_attribute_group);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	cells_dir = kobject_create_and_add(<span class="string">&quot;cells&quot;</span>, &amp;dev-&gt;kobj);</span><br><span class="line">	<span class="keyword">if</span> (!cells_dir) &#123;</span><br><span class="line">		sysfs_remove_group(&amp;dev-&gt;kobj, &amp;jailhouse_attribute_group);</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sysfs_create_group 是 Linux 内核中用于在 sysfs（系统文件系统）中创建属性组（attribute group）的函数。Sysfs 提供了一种将内核信息以文件和目录的形式暴露给用户空间的机制，而属性组则允许将相关的属性组织在一起。</p>
<p>kobject_create_and_add 是 Linux 内核中用于创建并添加内核对象（kobject）的函数。Sysfs 提供了一种将内核中的对象以文件和目录的形式暴露给用户空间的机制。<br>这样创建的内核对象可以在 sysfs 中表示为一个目录，用户空间可以通过 sysfs 接口访问其中的文件和属性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jailhouse/driver/pci.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register jailhouse as a PCI device driver so it can claim assigned devices.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 0 on success, or error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_pci_register</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> pci_register_driver(&amp;jailhouse_pci_stub_driver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pci_register_driver 是 Linux 内核中用于注册 PCI 驱动程序的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">init_hypercall</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	jailhouse_use_vmcall = boot_cpu_has(X86_FEATURE_VMX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为默认支持 vmx，所以 jailhouse_use_vmcall 为 true。</p>
<p>这样，初始化的工作就完成了。</p>
<h3 id="jailhouse-ioctl"><a href="#jailhouse-ioctl" class="headerlink" title="jailhouse_ioctl"></a>jailhouse_ioctl</h3><p>jailhouse_ioctl 会根据传递进来的参数，判断调用哪个函数并执行。从这里可以看出，jailhouse 主要的函数有：<br>jailhouse_cmd_enable，jailhouse_cmd_disable，jailhouse_cmd_cell_create，jailhouse_cmd_cell_load，<br>jailhouse_cmd_cell_start，jailhouse_cmd_cell_destroy。</p>
<p>在 jailhouse&#x2F;tools&#x2F;jailhouse.c 中可以看到 jailhouse 的一些使用方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">jailhouse_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> ioctl,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (ioctl) &#123;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_ENABLE:</span><br><span class="line">		err = jailhouse_cmd_enable(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_system __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_DISABLE:</span><br><span class="line">		err = jailhouse_cmd_disable();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_CREATE:</span><br><span class="line">		err = jailhouse_cmd_cell_create(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_cell_create __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_LOAD:</span><br><span class="line">		err = jailhouse_cmd_cell_load(</span><br><span class="line">			(<span class="keyword">struct</span> jailhouse_cell_load __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_START:</span><br><span class="line">		err = jailhouse_cmd_cell_start((<span class="type">const</span> <span class="type">char</span> __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> JAILHOUSE_CELL_DESTROY:</span><br><span class="line">		err = jailhouse_cmd_cell_destroy((<span class="type">const</span> <span class="type">char</span> __user *)arg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="jailhouse-cmd-enable"><a href="#jailhouse-cmd-enable" class="headerlink" title="jailhouse_cmd_enable"></a>jailhouse_cmd_enable</h3><p>在对代码分析之前，需要看如何使用 enable 功能。查看 RVM1.5 中的 enable-rvm.sh（<a target="_blank" rel="noopener" href="https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/enable-rvm.sh%EF%BC%89%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%BD%BF%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E4%B8%BA%EF%BC%9A">https://github.com/rvm-rtos/RVM1.5/blob/main/scripts/guest/enable-rvm.sh）文件，可以看到使用的命令为：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JH_DIR=~/jailhouse</span><br><span class="line">JH=$JH_DIR/tools/jailhouse</span><br><span class="line">sudo $JH enable $JH_DIR/configs/x86/qemu-ubuntu.cell</span><br></pre></td></tr></table></figure>
<p>这里面 enable 后面附带一个参数： $JH_DIR&#x2F;configs&#x2F;x86&#x2F;qemu-ubuntu.cell。在 gen-config 中有这么一行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python3 ./tools/jailhouse-config-create --mem-hv 512M ./configs/x86/qemu-ubuntu.c</span><br></pre></td></tr></table></figure>
<p>这个会生成 qemu-ubuntu.c 文件，里面是关于 jailhouse 的一些配置。在后续 make 时，会根据该文件生成对应的 qemu-ubuntu.cell 文件。具体可以查看 jailhouse&#x2F;configs&#x2F;Makefile 文件。</p>
<p>接着，看 jailhouse_cmd_enable 的函数签名：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以看 jailhouse_cmd_enable 的调用路线：enable(argc, argv)(tools&#x2F;jailhouse.c) -&gt; ioctl(fd, JAILHOUSE_ENABLE, config) -&gt; jailhouse_cmd_enable((struct jailhouse_system __user *)arg)。<br>第一个 enable 函数中 argc 和 argv 跟 main 函数的一致。iocal 中的 fd 是打开 jailhouse 的文件描述符。config 是读取 argv 第三个参数所对应的文件内容。最后的 arg 就跟 config 对应。<br>根据以上内容可知，arg 对应的就是 $JH_DIR&#x2F;configs&#x2F;x86&#x2F;qemu-ubuntu.cell 文件的内容，即系统配置文件。</p>
<h4 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h4><p>在开始阅读代码之前，了解 hypervisor image 的内存布局。RVM 1.5 的内存布局如下图所示。</p>


<p>接下来详细分析以下 enable 的全过程。</p>
<h4 id="第一步，将-arg-中的前-sizeof-jailhouse-system-个字节拷贝到-config-header"><a href="#第一步，将-arg-中的前-sizeof-jailhouse-system-个字节拷贝到-config-header" class="headerlink" title="第一步，将 arg 中的前 sizeof(jailhouse_system) 个字节拷贝到 config_header"></a>第一步，将 arg 中的前 sizeof(jailhouse_system) 个字节拷贝到 config_header</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;config_header, arg, <span class="keyword">sizeof</span>(config_header)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">// 检查 config_header.signature 和 config_header.revision</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(config_header.signature, JAILHOUSE_SYSTEM_SIGNATURE,</span><br><span class="line">		   <span class="keyword">sizeof</span>(config_header.signature)) != <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Not a system configuration\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (config_header.revision != JAILHOUSE_CONFIG_REVISION) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Configuration revision mismatch\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	config_header.root_cell.name[JAILHOUSE_CELL_NAME_MAXLEN] = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第二步，上锁，增加模块引用计数，检查-vmx-功能是否打开"><a href="#第二步，上锁，增加模块引用计数，检查-vmx-功能是否打开" class="headerlink" title="第二步，上锁，增加模块引用计数，检查 vmx 功能是否打开"></a>第二步，上锁，增加模块引用计数，检查 vmx 功能是否打开</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// mutex_lock_interruptible 函数是一种获取互斥锁的方式，允许在等待锁的过程中被信号中断。</span></span><br><span class="line">    <span class="comment">// 这样的机制有助于避免在用户空间中调用的操作导致内核中断等待的死锁情况。</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;jailhouse_lock) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line">	err = -EBUSY;</span><br><span class="line">    <span class="comment">// try_module_get(THIS_MODULE) 是 Linux 内核中用于尝试增加模块引用计数的函数。</span></span><br><span class="line">    <span class="comment">// 模块引用计数是跟踪内核模块被使用的计数器，当模块被使用时，引用计数会增加，当不再使用时，引用计数会减少。</span></span><br><span class="line">    <span class="comment">// 引用计数为零时，模块可以被卸载。</span></span><br><span class="line">    <span class="comment">// jailhouse_enabled 代表是否已经启用，所以必须要为 false</span></span><br><span class="line">	<span class="keyword">if</span> (jailhouse_enabled || !try_module_get(THIS_MODULE))</span><br><span class="line">		<span class="keyword">goto</span> error_unlock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">	<span class="keyword">if</span> (boot_cpu_has(X86_FEATURE_VMX)) &#123;</span><br><span class="line">		u64 features;</span><br><span class="line"></span><br><span class="line">		rdmsrl(MSR_IA32_FEAT_CTL, features);</span><br><span class="line">		<span class="keyword">if</span> ((features &amp; FEAT_CTL_VMX_ENABLED_OUTSIDE_SMX) == <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: VT-x disabled by Firmware/BIOS\n&quot;</span>);</span><br><span class="line">			err = -ENODEV;</span><br><span class="line">			<span class="keyword">goto</span> error_put_module;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第三步，加载-hypervisor-镜像"><a href="#第三步，加载-hypervisor-镜像" class="headerlink" title="第三步，加载 hypervisor 镜像"></a>第三步，加载 hypervisor 镜像</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fw_name = jailhouse_get_fw_name();	<span class="comment">// rvm-intel.bin</span></span><br><span class="line">	<span class="keyword">if</span> (!fw_name) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Missing or unsupported HVM technology\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// request_firmware 是用于请求固件文件的函数。它允许内核驱动程序在运行时动态地获取与硬件设备相关的固件信息。</span></span><br><span class="line">	<span class="comment">// 这对于支持一些设备而无需将固件硬编码到内核中的情况非常有用。</span></span><br><span class="line">	<span class="comment">// request_firmware 用于请求名为 &quot;rvm-intel.bin&quot; 的固件文件。</span></span><br><span class="line">	<span class="comment">// 如果请求成功，固件数据将包含在 hypervisor-&gt;data 中，然后你可以在这个数据上执行你的操作。</span></span><br><span class="line">	<span class="comment">// 最后，使用 release_firmware 函数释放固件数据。</span></span><br><span class="line">    err = request_firmware(&amp;hypervisor, fw_name, jailhouse_dev);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Missing hypervisor image %s\n&quot;</span>, fw_name);</span><br><span class="line">		<span class="keyword">goto</span> error_put_module;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 内容在 rvm-intel.bin 中的 .header 节中，具体在 RVM1.5/src/header.rs/HvHeaderStuff 中。</span></span><br><span class="line">	header = (<span class="keyword">struct</span> jailhouse_header *)hypervisor-&gt;data;</span><br><span class="line"></span><br><span class="line">	err = -EINVAL;</span><br><span class="line">    <span class="comment">// 检查签名</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(header-&gt;signature, JAILHOUSE_SIGNATURE,</span><br><span class="line">		   <span class="keyword">sizeof</span>(header-&gt;signature)) != <span class="number">0</span> ||</span><br><span class="line">	    hypervisor-&gt;size &gt;= hv_mem-&gt;size)</span><br><span class="line">		<span class="keyword">goto</span> error_release_fw;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第四步，分配内存，建立虚拟映射，并用-hypervisor-初始化-hypervisor-mem"><a href="#第四步，分配内存，建立虚拟映射，并用-hypervisor-初始化-hypervisor-mem" class="headerlink" title="第四步，分配内存，建立虚拟映射，并用 hypervisor 初始化 hypervisor_mem"></a>第四步，分配内存，建立虚拟映射，并用 hypervisor 初始化 hypervisor_mem</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_memory</span> *<span class="title">hv_mem</span> =</span> &amp;config_header.hypervisor_memory;</span><br><span class="line"></span><br><span class="line">    jailhouse_firmware_free(); <span class="comment">// 释放 hypervisor_mem_res</span></span><br><span class="line"></span><br><span class="line">	hypervisor_mem_res = request_mem_region(hv_mem-&gt;phys_start,</span><br><span class="line">						hv_mem-&gt;size,</span><br><span class="line">						<span class="string">&quot;Jailhouse hypervisor&quot;</span>); <span class="comment">// 分配物理内存</span></span><br><span class="line">	<span class="keyword">if</span> (!hypervisor_mem_res) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: request_mem_region failed for hypervisor &quot;</span></span><br><span class="line">		       <span class="string">&quot;memory.\n&quot;</span>);</span><br><span class="line">		pr_notice(<span class="string">&quot;jailhouse: Did you reserve the memory with &quot;</span></span><br><span class="line">			  <span class="string">&quot;\&quot;memmap=\&quot; or \&quot;mem=\&quot;?\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> error_release_fw;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Map physical memory region reserved for Jailhouse. */</span></span><br><span class="line">	hypervisor_mem = jailhouse_ioremap(hv_mem-&gt;phys_start, remap_addr,</span><br><span class="line">					   hv_mem-&gt;size);	<span class="comment">// 建立虚拟映射</span></span><br><span class="line">	<span class="keyword">if</span> (!hypervisor_mem) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;jailhouse: Unable to map RAM reserved for hypervisor &quot;</span></span><br><span class="line">		       <span class="string">&quot;at %08lx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)hv_mem-&gt;phys_start);</span><br><span class="line">		<span class="keyword">goto</span> error_release_memreg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	console_page = (<span class="keyword">struct</span> jailhouse_virt_console*)</span><br><span class="line">		(hypervisor_mem + header-&gt;console_page);</span><br><span class="line">	last_console.valid = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy hypervisor&#x27;s binary image at beginning of the memory region</span></span><br><span class="line"><span class="comment">	 * and clear the rest to zero. */</span></span><br><span class="line">    <span class="comment">// 用 hypervisor 初始化 hypervisor_mem。</span></span><br><span class="line">	<span class="built_in">memcpy</span>(hypervisor_mem, hypervisor-&gt;data, hypervisor-&gt;size);</span><br><span class="line">	<span class="built_in">memset</span>(hypervisor_mem + hypervisor-&gt;size, <span class="number">0</span>,</span><br><span class="line">	       hv_mem-&gt;size - hypervisor-&gt;size);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第五步，完善-hypervisor-mem-数据"><a href="#第五步，完善-hypervisor-mem-数据" class="headerlink" title="第五步，完善 hypervisor_mem 数据"></a>第五步，完善 hypervisor_mem 数据</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    max_cpus = get_max_cpus(config_header.root_cell.cpu_set_size, arg);</span><br><span class="line">    header = (<span class="keyword">struct</span> jailhouse_header *)hypervisor_mem;</span><br><span class="line">	header-&gt;max_cpus = max_cpus;</span><br><span class="line">    <span class="comment">// 在 sysfs 中创建二进制文件。成功创建后，用户空间可以通过文件系统接口来读取该二进制文件。</span></span><br><span class="line">	err = jailhouse_sysfs_core_init(jailhouse_dev, header-&gt;core_size);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ARMv8 requires to clean D-cache and invalidate I-cache for memory</span></span><br><span class="line"><span class="comment">	 * containing new instructions. On x86 this is a NOP. On ARMv7 the</span></span><br><span class="line"><span class="comment">	 * firmware does its own cache maintenance, so it is an</span></span><br><span class="line"><span class="comment">	 * extraneous (but harmless) flush.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	flush_icache_range((<span class="type">unsigned</span> <span class="type">long</span>)hypervisor_mem,</span><br><span class="line">			   (<span class="type">unsigned</span> <span class="type">long</span>)(hypervisor_mem + header-&gt;core_size));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy system configuration to its target address in hypervisor memory</span></span><br><span class="line"><span class="comment">	 * region. */</span></span><br><span class="line">	config = (<span class="keyword">struct</span> jailhouse_system *)</span><br><span class="line">		(hypervisor_mem + hv_core_and_percpu_size);</span><br><span class="line">	<span class="comment">// 将 qemu-ubuntu.c 中的 config 写入 hypervisor_mem 中的 systemconfig 区域</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(config, arg, config_size)) &#123;</span><br><span class="line">		err = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (config-&gt;debug_console.clock_reg) &#123;</span><br><span class="line">		clock_reg = ioremap(config-&gt;debug_console.clock_reg,</span><br><span class="line">				    <span class="keyword">sizeof</span>(clock_gates));</span><br><span class="line">		<span class="keyword">if</span> (!clock_reg) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: Unable to map clock register at &quot;</span></span><br><span class="line">			       <span class="string">&quot;%08lx\n&quot;</span>,</span><br><span class="line">			       (<span class="type">unsigned</span> <span class="type">long</span>)config-&gt;debug_console.clock_reg);</span><br><span class="line">			<span class="keyword">goto</span> error_unmap;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		clock_gates = readl(clock_reg);</span><br><span class="line">		<span class="keyword">if</span> (CON_HAS_INVERTED_GATE(config-&gt;debug_console.flags))</span><br><span class="line">			clock_gates &amp;= ~(<span class="number">1</span> &lt;&lt; config-&gt;debug_console.gate_nr);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			clock_gates |= (<span class="number">1</span> &lt;&lt; config-&gt;debug_console.gate_nr);</span><br><span class="line">		writel(clock_gates, clock_reg);</span><br><span class="line"></span><br><span class="line">		iounmap(clock_reg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> JAILHOUSE_BORROW_ROOT_PT</span></span><br><span class="line">	<span class="keyword">if</span> (CON_IS_MMIO(config-&gt;debug_console.flags)) &#123;</span><br><span class="line">		console = ioremap(config-&gt;debug_console.address,</span><br><span class="line">				  config-&gt;debug_console.size);</span><br><span class="line">		<span class="keyword">if</span> (!console) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			pr_err(<span class="string">&quot;jailhouse: Unable to map hypervisor debug &quot;</span></span><br><span class="line">			       <span class="string">&quot;console at %08lx\n&quot;</span>,</span><br><span class="line">			       (<span class="type">unsigned</span> <span class="type">long</span>)config-&gt;debug_console.address);</span><br><span class="line">			<span class="keyword">goto</span> error_unmap;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* The hypervisor has no notion of address spaces, so we need</span></span><br><span class="line"><span class="comment">		 * to enforce conversion. */</span></span><br><span class="line">		header-&gt;debug_console_base = (<span class="type">void</span> * __force)console;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	console_available = SYS_FLAGS_VIRTUAL_DEBUG_CONSOLE(config-&gt;flags);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">	<span class="keyword">if</span> (config-&gt;platform_info.x86.tsc_khz == <span class="number">0</span>)</span><br><span class="line">		config-&gt;platform_info.x86.tsc_khz = tsc_khz;</span><br><span class="line">	<span class="keyword">if</span> (config-&gt;platform_info.x86.apic_khz == <span class="number">0</span>)</span><br><span class="line">		config-&gt;platform_info.x86.apic_khz =</span><br><span class="line">			*lapic_timer_period_sym / (<span class="number">1000</span> / HZ);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第六步，创建-cell"><a href="#第六步，创建-cell" class="headerlink" title="第六步，创建 cell"></a>第六步，创建 cell</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> cell *<span class="title function_">cell_create</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> jailhouse_cell_desc *cell_desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cell</span> *<span class="title">cell</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> id;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cell_desc-&gt;num_memory_regions &gt;=</span><br><span class="line">	    ULONG_MAX / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* determine cell id */</span></span><br><span class="line">	id = <span class="number">0</span>;</span><br><span class="line">retry:</span><br><span class="line">	list_for_each_entry(cell, &amp;cells, entry)</span><br><span class="line">		<span class="keyword">if</span> (cell-&gt;id == id) &#123;</span><br><span class="line">			id++;</span><br><span class="line">			<span class="keyword">goto</span> retry;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	cell = kzalloc(<span class="keyword">sizeof</span>(*cell), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!cell)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;cell-&gt;entry);</span><br><span class="line">    <span class="comment">// 用 cell_desc 初始化 cell</span></span><br><span class="line">	cell-&gt;id = id;</span><br><span class="line"></span><br><span class="line">	bitmap_copy(cpumask_bits(&amp;cell-&gt;cpus_assigned),</span><br><span class="line">		    jailhouse_cell_cpu_set(cell_desc),</span><br><span class="line">		    min((<span class="type">unsigned</span> <span class="type">int</span>)nr_cpumask_bits,</span><br><span class="line">		        cell_desc-&gt;cpu_set_size * <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">	cell-&gt;num_memory_regions = cell_desc-&gt;num_memory_regions;</span><br><span class="line">	cell-&gt;memory_regions = vmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory) *</span><br><span class="line">				       cell-&gt;num_memory_regions);</span><br><span class="line">	<span class="keyword">if</span> (!cell-&gt;memory_regions) &#123;</span><br><span class="line">		kfree(cell);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(cell-&gt;name, cell_desc-&gt;name, JAILHOUSE_CELL_ID_NAMELEN);</span><br><span class="line">	cell-&gt;name[JAILHOUSE_CELL_ID_NAMELEN] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(cell-&gt;memory_regions, jailhouse_cell_mem_regions(cell_desc),</span><br><span class="line">	       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> jailhouse_memory) * cell-&gt;num_memory_regions);</span><br><span class="line">    </span><br><span class="line">	err = jailhouse_pci_cell_setup(cell, cell_desc);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		vfree(cell-&gt;memory_regions);</span><br><span class="line">		kfree(cell);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 使用 kobject_init_and_add 初始化和添加内核对象。</span></span><br><span class="line">    <span class="comment">// 成功添加后，用户空间可以通过 sysfs 文件系统接口访问该对象。</span></span><br><span class="line">    <span class="comment">// 然后调用 sysfs_create_group 在 sysfs 中创建属性组。</span></span><br><span class="line">    <span class="comment">// 成功创建后，用户空间可以通过文件系统接口访问该属性组。</span></span><br><span class="line">	err = jailhouse_sysfs_cell_create(cell);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="comment">/* cleanup done by jailhouse_sysfs_cell_create */</span></span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">jailhouse_cell_prepare_root</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> jailhouse_cell_desc *cell_desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	root_cell = cell_create(cell_desc);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(root_cell))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(root_cell);</span><br><span class="line"></span><br><span class="line">	cpumask_and(&amp;root_cell-&gt;cpus_assigned, &amp;root_cell-&gt;cpus_assigned,</span><br><span class="line">		    cpu_online_mask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    err = jailhouse_cell_prepare_root(&amp;config-&gt;root_cell);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> error_unmap;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第七步，跳转到-RVM1-5-中执行"><a href="#第七步，跳转到-RVM1-5-中执行" class="headerlink" title="第七步，跳转到 RVM1.5 中执行"></a>第七步，跳转到 RVM1.5 中执行</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    preempt_disable();</span><br><span class="line"></span><br><span class="line">	header-&gt;online_cpus = num_online_cpus();</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// on_each_cpu 是 Linux 内核中用于在所有 CPU 上执行指定函数的宏。</span></span><br><span class="line">    <span class="comment">// 该宏的目的是在对称多处理（SMP）系统中并行地执行相同的函数，以便在所有 CPU 上进行某些全局操作。</span></span><br><span class="line">    <span class="comment">// 第一个参数：指向将在每个 CPU 上执行的函数的指针。</span></span><br><span class="line">    <span class="comment">// 第二个参数：传递给 func 函数的额外参数。</span></span><br><span class="line">    <span class="comment">// 第三个参数：指定是否等待所有 CPU 上的函数执行完成。如果为 1，等待；如果为 0，不等待。</span></span><br><span class="line">	on_each_cpu(enter_hypervisor, header, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 等待所有 cpu 完成</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called for each cpu by the JAILHOUSE_ENABLE ioctl.</span></span><br><span class="line"><span class="comment"> * It jumps to the entry point set in the header, reports the result and</span></span><br><span class="line"><span class="comment"> * signals completion to the main thread that invoked it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">enter_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_header</span> *<span class="title">header</span> =</span> info;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu = smp_processor_id();</span><br><span class="line">	<span class="type">int</span> (*entry)(<span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">    <span class="comment">// 查看 RVM1.5/linker.lds，__entry_offset = arch_entry - BASE_ADDRESS;</span></span><br><span class="line">	entry = header-&gt;entry + (<span class="type">unsigned</span> <span class="type">long</span>) hypervisor_mem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpu &lt; header-&gt;max_cpus)</span><br><span class="line">		<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">        <span class="comment">// 进入 RVM1.5 执行</span></span><br><span class="line">		err = entry(cpu);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		err = -EINVAL;</span><br><span class="line">    <span class="comment">// 此时，已经进入 guest 状态执行</span></span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now on - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第八步，进入-RVM-1-5，从-arch-entry-到-main-函数"><a href="#第八步，进入-RVM-1-5，从-arch-entry-到-main-函数" class="headerlink" title="第八步，进入 RVM 1.5，从 arch_entry 到 main 函数"></a>第八步，进入 RVM 1.5，从 arch_entry 到 main 函数</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">arch_entry</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    core::arch::asm!(<span class="string">&quot;</span></span><br><span class="line"><span class="string">        // rip is pushed</span></span><br><span class="line"><span class="string">        cli</span></span><br><span class="line"><span class="string">        push rbp</span></span><br><span class="line"><span class="string">        push rbx</span></span><br><span class="line"><span class="string">        push r12</span></span><br><span class="line"><span class="string">        push r13</span></span><br><span class="line"><span class="string">        push r14</span></span><br><span class="line"><span class="string">        push r15</span></span><br><span class="line"><span class="string">        push 0  // skip gs_base</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rdi, rsp    // switch_stack 参数为此时的栈指针</span></span><br><span class="line"><span class="string">        call &#123;0&#125; // 调用 switch_stack</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        pop r15 // skip gs_base</span></span><br><span class="line"><span class="string">        pop r15</span></span><br><span class="line"><span class="string">        pop r14</span></span><br><span class="line"><span class="string">        pop r13</span></span><br><span class="line"><span class="string">        pop r12</span></span><br><span class="line"><span class="string">        pop rbx</span></span><br><span class="line"><span class="string">        pop rbp</span></span><br><span class="line"><span class="string">        ret</span></span><br><span class="line"><span class="string">        // rip will pop when return&quot;</span>,</span><br><span class="line">        sym switch_stack,</span><br><span class="line">        <span class="title function_ invoke__">options</span>(noreturn),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// extern &quot;sysv64&quot; 通过 FFI 调用 非Windows x86_64 平台下的 C 资源所使用的默认调用约定。</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">&quot;sysv64&quot;</span> <span class="keyword">fn</span> <span class="title function_">switch_stack</span>(linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">linux_tp</span> = Msr::IA32_GS_BASE.<span class="title function_ invoke__">read</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpu_data</span> = <span class="keyword">match</span> PerCpu::<span class="title function_ invoke__">new</span>() &#123;    <span class="comment">// 初始化 cpu_data</span></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(c) =&gt; c,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> e.<span class="title function_ invoke__">code</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">hv_sp</span> = cpu_data.<span class="title function_ invoke__">stack_top</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ret</span>;</span><br><span class="line">    core::arch::asm!(<span class="string">&quot;</span></span><br><span class="line"><span class="string">        mov [rsi], &#123;linux_tp&#125;   // save gs_base to stack</span></span><br><span class="line"><span class="string">        mov rcx, rsp            // 保存 rsp</span></span><br><span class="line"><span class="string">        mov rsp, &#123;hv_sp&#125;        // 更换 rsp</span></span><br><span class="line"><span class="string">        push rcx</span></span><br><span class="line"><span class="string">        call &#123;entry&#125;</span></span><br><span class="line"><span class="string">        pop rsp&quot;</span>,</span><br><span class="line">        entry = sym crate::entry,</span><br><span class="line">        linux_tp = <span class="title function_ invoke__">in</span>(reg) linux_tp,</span><br><span class="line">        hv_sp = <span class="title function_ invoke__">in</span>(reg) hv_sp,</span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdi&quot;</span>) cpu_data, <span class="comment">// entry 第一个参数</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rsi&quot;</span>) linux_sp, <span class="comment">// entry 第二个参数</span></span><br><span class="line">        <span class="title function_ invoke__">lateout</span>(<span class="string">&quot;rax&quot;</span>) ret, <span class="comment">// rax 为返回值，为 ret</span></span><br><span class="line">        <span class="title function_ invoke__">out</span>(<span class="string">&quot;rcx&quot;</span>) _,</span><br><span class="line">    );</span><br><span class="line">    Msr::IA32_GS_BASE.<span class="title function_ invoke__">write</span>(linux_tp);</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;sysv64&quot;</span> <span class="keyword">fn</span> <span class="title function_">entry</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="title function_ invoke__">main</span>(cpu_data, linux_sp) &#123;</span><br><span class="line">        error!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, e);</span><br><span class="line">        ERROR_NUM.<span class="title function_ invoke__">store</span>(e.<span class="title function_ invoke__">code</span>(), Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">code</span> = ERROR_NUM.<span class="title function_ invoke__">load</span>(Ordering::Acquire);</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">&quot;CPU &#123;&#125; return back to driver with code &#123;&#125;.&quot;</span>,</span><br><span class="line">        cpu_data.id, code</span><br><span class="line">    );</span><br><span class="line">    code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第九步，primary-init-early"><a href="#第九步，primary-init-early" class="headerlink" title="第九步，primary_init_early"></a>第九步，primary_init_early</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="comment">// 此时 cpu_data 状态为：state 为 HvDisabled，LinuxContext 为空</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_primary</span> = cpu_data.id == <span class="number">0</span>;  <span class="comment">// primary cpu</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">online_cpus</span> = HvHeader::<span class="title function_ invoke__">get</span>().online_cpus; <span class="comment">//HvHeaderStuff 的数据</span></span><br><span class="line">    <span class="title function_ invoke__">wait_for</span>(|| PerCpu::<span class="title function_ invoke__">entered_cpus</span>() &lt; online_cpus)?; <span class="comment">// 同步</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_primary &#123;</span><br><span class="line">        <span class="title function_ invoke__">primary_init_early</span>()?;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 等待 primary_init_early 完成</span></span><br><span class="line">        <span class="title function_ invoke__">wait_for_counter</span>(&amp;INIT_EARLY_OK, <span class="number">1</span>)?    </span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">primary_init_early</span>() <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    logging::<span class="title function_ invoke__">init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">system_config</span> = HvSystemConfig::<span class="title function_ invoke__">get</span>();  <span class="comment">// 获取 system_config</span></span><br><span class="line"></span><br><span class="line">    memory::<span class="title function_ invoke__">init_heap</span>();    <span class="comment">// 分配一段 32 MB 内存，初始化 PHYS_VIRT_OFFSET</span></span><br><span class="line">    system_config.<span class="title function_ invoke__">check</span>()?; <span class="comment">// 检查 signature 和 revision</span></span><br><span class="line"></span><br><span class="line">    memory::<span class="title function_ invoke__">init_frame_allocator</span>(); <span class="comment">// 初始化物理内存分配器</span></span><br><span class="line">    memory::<span class="title function_ invoke__">init_hv_page_table</span>()?;  <span class="comment">// 初始化 HV_PT，hypervisor 用的页表</span></span><br><span class="line">    cell::<span class="title function_ invoke__">init</span>()?;  <span class="comment">// 初始化 ROOT_CELL，包括页表和 CellConfig</span></span><br><span class="line"></span><br><span class="line">    INIT_EARLY_OK.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十步，更新-cpu-data"><a href="#第十步，更新-cpu-data" class="headerlink" title="第十步，更新 cpu_data"></a>第十步，更新 cpu_data</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    cpu_data.<span class="title function_ invoke__">init</span>(linux_sp, cell::<span class="title function_ invoke__">root_cell</span>())?;    <span class="comment">// 初始化 Vcpu，state，linux</span></span><br><span class="line">    INITED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">    <span class="title function_ invoke__">wait_for_counter</span>(&amp;INITED_CPUS, online_cpus)?;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux_sp: <span class="type">usize</span>, cell: &amp;Cell) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="comment">// Save CPU state used for linux.</span></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvDisabled;</span><br><span class="line">        <span class="keyword">self</span>.linux = LinuxContext::<span class="title function_ invoke__">load_from</span>(linux_sp);</span><br><span class="line">        <span class="keyword">self</span>.arch.<span class="title function_ invoke__">init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Activate hypervisor page table on each cpu.</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; crate::memory::<span class="title function_ invoke__">hv_page_table</span>().<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">activate</span>() &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize vCPU. Use `ptr::write()` to avoid dropping</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::ptr::<span class="title function_ invoke__">write</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vcpu, Vcpu::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.linux, cell)?) &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvEnabled;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LinuxContext</span> &#123;</span><br><span class="line">    <span class="comment">/// Load linux callee-saved registers from the stack, and other system registers.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_from</span>(linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// 注意，这里的 linux_sp 为更换栈之前的栈指针</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts</span>(linux_sp <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u64</span>, SAVED_LINUX_REGS) &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">gdt</span> = GdtStruct::<span class="title function_ invoke__">sgdt</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">fs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">fs</span>(), &amp;gdt);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">gs</span>(), &amp;gdt);</span><br><span class="line">        fs.base = Msr::IA32_FS_BASE.<span class="title function_ invoke__">read</span>();</span><br><span class="line">        gs.base = regs[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="comment">// 注意，这里的 rsp 并不是直接等于 linux_sp，而是 regs 末尾，相当于 linux_sp 对应的栈中 r15 到 rip 全出栈</span></span><br><span class="line">            rsp: regs.<span class="title function_ invoke__">as_ptr_range</span>().end <span class="keyword">as</span> _,  </span><br><span class="line">            r15: regs[<span class="number">1</span>],</span><br><span class="line">            r14: regs[<span class="number">2</span>],</span><br><span class="line">            r13: regs[<span class="number">3</span>],</span><br><span class="line">            r12: regs[<span class="number">4</span>],</span><br><span class="line">            rbx: regs[<span class="number">5</span>],</span><br><span class="line">            rbp: regs[<span class="number">6</span>],</span><br><span class="line">            <span class="comment">// 进入 arch_entry 前，要把返回地址压栈，所以 rip 中保存的应该是 enter_hypervisor 中 entry(cpu) 的下一条指令。</span></span><br><span class="line">            rip: regs[<span class="number">7</span>],</span><br><span class="line">            es: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">es</span>(), &amp;gdt),</span><br><span class="line">            cs: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">cs</span>(), &amp;gdt),</span><br><span class="line">            ss: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">ss</span>(), &amp;gdt),</span><br><span class="line">            ds: Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">ds</span>(), &amp;gdt),</span><br><span class="line">            fs,</span><br><span class="line">            gs,</span><br><span class="line">            tss: Segment::<span class="title function_ invoke__">from_selector</span>(<span class="keyword">unsafe</span> &#123; task::<span class="title function_ invoke__">tr</span>() &#125;, &amp;gdt),</span><br><span class="line">            gdt,</span><br><span class="line">            idt: IdtStruct::<span class="title function_ invoke__">sidt</span>(),</span><br><span class="line">            cr0: Cr0::<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            cr3: Cr3::<span class="title function_ invoke__">read</span>().<span class="number">0</span>.<span class="title function_ invoke__">start_address</span>().<span class="title function_ invoke__">as_u64</span>(),</span><br><span class="line">            cr4: Cr4::<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            efer: Msr::IA32_EFER.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            star: Msr::IA32_STAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            lstar: Msr::IA32_LSTAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            cstar: Msr::IA32_CSTAR.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            fmask: Msr::IA32_FMASK.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            kernel_gsbase: Msr::IA32_KERNEL_GSBASE.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            pat: Msr::IA32_PAT.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">            mtrr_def_type: Msr::IA32_MTRR_DEF_TYPE.<span class="title function_ invoke__">read</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十一步，activate-vmm"><a href="#第十一步，activate-vmm" class="headerlink" title="第十一步，activate_vmm"></a>第十一步，activate_vmm</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_data: &amp;<span class="keyword">mut</span> PerCpu, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="keyword">if</span> is_primary &#123; </span><br><span class="line">        <span class="title function_ invoke__">primary_init_late</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 等待 primary_init_late 完成</span></span><br><span class="line">        <span class="title function_ invoke__">wait_for_counter</span>(&amp;INIT_LATE_OK, <span class="number">1</span>)?</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cpu_data.<span class="title function_ invoke__">activate_vmm</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">activate_vmm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Activating hypervisor on CPU &#123;&#125;...&quot;</span>, <span class="keyword">self</span>.id);</span><br><span class="line">        ACTIVATED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">enter</span>(&amp;<span class="keyword">self</span>.linux)?;</span><br><span class="line">        <span class="built_in">unreachable!</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Vcpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">enter</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux: &amp;LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">regs_mut</span>();</span><br><span class="line">        regs.rax = <span class="number">0</span>;</span><br><span class="line">        regs.rbx = linux.rbx;</span><br><span class="line">        regs.rbp = linux.rbp;</span><br><span class="line">        regs.r12 = linux.r12;</span><br><span class="line">        regs.r13 = linux.r13;</span><br><span class="line">        regs.r14 = linux.r14;</span><br><span class="line">        regs.r15 = linux.r15;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            asm!(</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;0&#125;&quot;</span>,</span><br><span class="line">                restore_regs_from_stack!(),</span><br><span class="line">                <span class="string">&quot;vmlaunch&quot;</span>, <span class="comment">// 进入 guest 执行，执行的地址为前面加载的 rip</span></span><br><span class="line">                <span class="title function_ invoke__">in</span>(reg) regs <span class="keyword">as</span> * <span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Never return if successful</span></span><br><span class="line">        error!(</span><br><span class="line">            <span class="string">&quot;Activate hypervisor failed: &#123;:?&#125;&quot;</span>,</span><br><span class="line">            Vmcs::<span class="title function_ invoke__">instruction_error</span>()</span><br><span class="line">        );</span><br><span class="line">        hv_result_err!(EIO)</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第十二步，guest-运行"><a href="#第十二步，guest-运行" class="headerlink" title="第十二步，guest 运行"></a>第十二步，guest 运行</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">enter_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jailhouse_header</span> *<span class="title">header</span> =</span> info;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu = smp_processor_id();</span><br><span class="line">	<span class="type">int</span> (*entry)(<span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	entry = header-&gt;entry + (<span class="type">unsigned</span> <span class="type">long</span>) hypervisor_mem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpu &lt; header-&gt;max_cpus)</span><br><span class="line">		<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">		err = entry(cpu);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		err = -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)    <span class="comment">// guest 运行的第一条指令</span></span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now on - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_enable</span><span class="params">(<span class="keyword">struct</span> jailhouse_system __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    preempt_disable();</span><br><span class="line"></span><br><span class="line">	header-&gt;online_cpus = num_online_cpus();</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">	on_each_cpu(enter_hypervisor, header, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (error_code) &#123;</span><br><span class="line">		err = error_code;</span><br><span class="line">		<span class="keyword">goto</span> error_free_cell;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 现在处于 guest 中，把不必要的资源关闭</span></span><br><span class="line">	<span class="keyword">if</span> (console)</span><br><span class="line">		iounmap(console);</span><br><span class="line"></span><br><span class="line">	release_firmware(hypervisor);</span><br><span class="line">    <span class="comment">// 注册一个 cellid 为 0 的 cell</span></span><br><span class="line">	jailhouse_cell_register_root();</span><br><span class="line">    <span class="comment">// 增加 PCI 设备</span></span><br><span class="line">	jailhouse_pci_virtual_root_devices_add(&amp;config_header);</span><br><span class="line"></span><br><span class="line">	jailhouse_enabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;jailhouse_lock);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;The Jailhouse is opening.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jailhouse-cmd-disable"><a href="#jailhouse-cmd-disable" class="headerlink" title="jailhouse_cmd_disable"></a>jailhouse_cmd_disable</h3><h4 id="jailhouse-部分"><a href="#jailhouse-部分" class="headerlink" title="jailhouse 部分"></a>jailhouse 部分</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jailhouse_cmd_disable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">    <span class="comment">// 上锁</span></span><br><span class="line">	<span class="keyword">if</span> (mutex_lock_interruptible(&amp;jailhouse_lock) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line">    <span class="comment">// jailhouse_enabled 要为 true</span></span><br><span class="line">	<span class="keyword">if</span> (!jailhouse_enabled) &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 回收 jailhouse 相关资源 </span></span><br><span class="line">	err = jailhouse_cmd_cell_destroy_non_root();</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line"></span><br><span class="line">	jailhouse_pci_virtual_root_devices_remove();</span><br><span class="line"></span><br><span class="line">	error_code = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	preempt_disable();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (num_online_cpus() != cpumask_weight(&amp;root_cell-&gt;cpus_assigned)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Not all assigned CPUs are currently online. If we disable</span></span><br><span class="line"><span class="comment">		 * now, we will lose the offlined ones.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line"></span><br><span class="line">		preempt_enable();</span><br><span class="line"></span><br><span class="line">		err = -EBUSY;</span><br><span class="line">		<span class="keyword">goto</span> unlock_out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;call_done, <span class="number">0</span>);</span><br><span class="line">	on_each_cpu(leave_hypervisor, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="type">atomic_read</span>(&amp;call_done) != num_online_cpus())</span><br><span class="line">		cpu_relax();</span><br><span class="line"></span><br><span class="line">	preempt_enable();</span><br><span class="line"></span><br><span class="line">	err = error_code;</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;jailhouse: Failed to disable hypervisor: %d\n&quot;</span>, err);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jailhouse_cell_delete_root();</span><br><span class="line">	jailhouse_enabled = <span class="literal">false</span>;</span><br><span class="line">	module_put(THIS_MODULE);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;The Jailhouse was closed.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">unlock_out:</span><br><span class="line">	mutex_unlock(&amp;jailhouse_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">leave_hypervisor</span><span class="params">(<span class="type">void</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> *page;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Touch each hypervisor page we may need during the switch so that</span></span><br><span class="line"><span class="comment">	 * the active mm definitely contains all mappings. At least x86 does</span></span><br><span class="line"><span class="comment">	 * not support taking any faults while switching worlds. */</span></span><br><span class="line">	<span class="keyword">for</span> (page = hypervisor_mem;</span><br><span class="line">	     page &lt; hypervisor_mem + hv_core_and_percpu_size;</span><br><span class="line">	     page += PAGE_SIZE)</span><br><span class="line">		readl((<span class="type">void</span> __iomem *)page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* either returns 0 or the same error code across all CPUs */</span></span><br><span class="line">	err = jailhouse_call(JAILHOUSE_HC_DISABLE);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		error_code = err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_X86) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,0,0)</span></span><br><span class="line">	<span class="comment">/* on Intel, VMXE is now off - update the shadow */</span></span><br><span class="line">	cr4_init_shadow();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_inc</span>(&amp;call_done);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_CODE	\</span></span><br><span class="line"><span class="meta">	<span class="string">&quot;cmpb $0x01, %[use_vmcall]\n\t&quot;</span>\    <span class="comment">// 判断 jailhouse_use_vmcall 是否为 1</span></span></span><br><span class="line">	<span class="string">&quot;jne 1f\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;vmcall\n\t&quot;</span>\                       <span class="comment">// 触发 vmexit</span></span><br><span class="line">	<span class="string">&quot;jmp 2f\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;1: vmmcall\n\t&quot;</span>\</span><br><span class="line">	<span class="string">&quot;2:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_RESULT	<span class="string">&quot;=a&quot;</span> (result)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_USE_VMCALL	[use_vmcall] <span class="string">&quot;m&quot;</span> (jailhouse_use_vmcall)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JAILHOUSE_CALL_NUM	<span class="string">&quot;a&quot;</span> (num)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u32 <span class="title function_">jailhouse_call</span><span class="params">(__u32 num)</span></span><br><span class="line">&#123;</span><br><span class="line">	__u32 result;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(JAILHOUSE_CALL_CODE</span></span><br><span class="line"><span class="params">		: JAILHOUSE_CALL_RESULT</span></span><br><span class="line"><span class="params">		: JAILHOUSE_USE_VMCALL, JAILHOUSE_CALL_NUM</span></span><br><span class="line"><span class="params">		: <span class="string">&quot;memory&quot;</span>)</span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RVM1-5-部分"><a href="#RVM1-5-部分" class="headerlink" title="RVM1.5 部分"></a>RVM1.5 部分</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">VmExit</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">handle_exit</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">match</span> exit_info.exit_reason &#123;</span><br><span class="line">            VmxExitReason::EXCEPTION_NMI =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_exception_nmi</span>(&amp;exit_info),</span><br><span class="line">            VmxExitReason::CPUID =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_cpuid</span>(),</span><br><span class="line">            VmxExitReason::VMCALL =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_hypercall</span>(),   <span class="comment">// vmcall 触发</span></span><br><span class="line">            VmxExitReason::MSR_READ =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_msr_read</span>(),</span><br><span class="line">            VmxExitReason::MSR_WRITE =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_msr_write</span>(),</span><br><span class="line">            VmxExitReason::EPT_VIOLATION =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">handle_ept_violation</span>(&amp;exit_info),</span><br><span class="line">            VmxExitReason::TRIPLE_FAULT =&gt; &#123;</span><br><span class="line">                error!(<span class="string">&quot;Triple fault: &#123;:#x?&#125;&quot;</span>, exit_info);</span><br><span class="line">                <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">inject_fault</span>()?;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; hv_result_err!(ENOSYS),</span><br><span class="line">        &#125;;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">handle_hypercall</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">use</span> crate::hypercall::HyperCall;</span><br><span class="line">        <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">advance_rip</span>(VM_EXIT_LEN_HYPERCALL)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">guest_regs</span> = <span class="keyword">self</span>.cpu_data.vcpu.<span class="title function_ invoke__">regs</span>();</span><br><span class="line">        <span class="keyword">let</span> (code, arg0, arg1) = (guest_regs.rax, guest_regs.rdi, guest_regs.rsi);</span><br><span class="line">        HyperCall::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.cpu_data).<span class="title function_ invoke__">hypercall</span>(code <span class="keyword">as</span> _, arg0, arg1)?;    <span class="comment">// 调用 hypercall</span></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>&gt; HyperCall&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hypercall</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, code: <span class="type">u32</span>, arg0: <span class="type">u64</span>, _arg1: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ret</span> = <span class="keyword">match</span> code &#123;</span><br><span class="line">            HyperCallCode::HypervisorDisable =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">hypervisor_disable</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">hypervisor_disable</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HyperCallResult &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpus</span> = PerCpu::<span class="title function_ invoke__">activated_cpus</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> TRY_DISABLE_CPUS: AtomicU32 = AtomicU32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line">        TRY_DISABLE_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">        <span class="keyword">while</span> TRY_DISABLE_CPUS.<span class="title function_ invoke__">load</span>(Ordering::Acquire) &lt; cpus &#123;</span><br><span class="line">            core::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.cpu_data.<span class="title function_ invoke__">deactivate_vmm</span>(<span class="number">0</span>)?;   <span class="comment">// 关闭 vmm</span></span><br><span class="line">        <span class="built_in">unreachable!</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PerCpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">deactivate_vmm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ret_code: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Deactivating hypervisor on CPU &#123;&#125;...&quot;</span>, <span class="keyword">self</span>.id);</span><br><span class="line">        ACTIVATED_CPUS.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">set_return_val</span>(ret_code);</span><br><span class="line">        <span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">exit</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.linux)?;</span><br><span class="line">        <span class="keyword">self</span>.linux.<span class="title function_ invoke__">restore</span>();   <span class="comment">// 用 self.linux 恢复系统寄存器</span></span><br><span class="line">        <span class="keyword">self</span>.state = CpuState::HvDisabled;</span><br><span class="line">        <span class="keyword">self</span>.linux.<span class="title function_ invoke__">return_to_linux</span>(<span class="keyword">self</span>.vcpu.<span class="title function_ invoke__">regs</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Vcpu</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">exit</span>(&amp;<span class="keyword">self</span>, linux: &amp;<span class="keyword">mut</span> LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">load_vmcs_guest</span>(linux)?;   <span class="comment">// 保存 guest 的状态到 linux</span></span><br><span class="line">        Vmcs::<span class="title function_ invoke__">clear</span>(<span class="keyword">self</span>.vmcs_region.<span class="title function_ invoke__">paddr</span>())?;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; vmx::<span class="title function_ invoke__">vmxoff</span>()? &#125;;</span><br><span class="line">        info!(<span class="string">&quot;successed to turn off VMX.&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LinuxContext</span> &#123;</span><br><span class="line">    <span class="comment">/// Restore linux general-purpose registers and stack, then return back to linux.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">return_to_linux</span>(&amp;<span class="keyword">self</span>, guest_regs: &amp;GeneralRegisters) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">        <span class="comment">// 用 guest 状态恢复 linux，栈换成 linux_rsp，跳转到 linux_rip 执行</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            Msr::IA32_GS_BASE.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.gs.base);</span><br><span class="line">            core::arch::asm!(</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;linux_rsp&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;push &#123;linux_rip&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov rcx, rsp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov rsp, &#123;guest_regs&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mov [rsp + &#123;guest_regs_size&#125;], rcx&quot;</span>,</span><br><span class="line">                restore_regs_from_stack!(),</span><br><span class="line">                <span class="string">&quot;pop rsp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ret&quot;</span>,</span><br><span class="line">                linux_rsp = <span class="title function_ invoke__">in</span>(reg) <span class="keyword">self</span>.rsp,</span><br><span class="line">                linux_rip = <span class="title function_ invoke__">in</span>(reg) <span class="keyword">self</span>.rip,</span><br><span class="line">                guest_regs = <span class="title function_ invoke__">in</span>(reg) guest_regs,</span><br><span class="line">                guest_regs_size = <span class="keyword">const</span> core::mem::size_of::&lt;GeneralRegisters&gt;(),</span><br><span class="line">                <span class="title function_ invoke__">options</span>(noreturn),</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/af2a573a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/af2a573a.html" class="post-title-link" itemprop="url">arceos 之 hypervisor-x86 源码阅读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-01-09 21:31:39" itemprop="dateCreated datePublished" datetime="2024-01-09T21:31:39+08:00">2024-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-10 15:18:12" itemprop="dateModified" datetime="2024-01-10T15:18:12+08:00">2024-01-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>源代码地址：<a target="_blank" rel="noopener" href="https://github.com/arceos-hypervisor/arceos/tree/hypervisor-x86">https://github.com/arceos-hypervisor/arceos/tree/hypervisor-x86</a></p>
<h2 id="apps-hv-src-main-rs"><a href="#apps-hv-src-main-rs" class="headerlink" title="apps&#x2F;hv&#x2F;src&#x2F;main.rs"></a>apps&#x2F;hv&#x2F;src&#x2F;main.rs</h2><p>创建虚拟机全过程：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(hart_id: <span class="type">usize</span>) &#123;</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">&quot;Hello, hv!&quot;</span>);</span><br><span class="line">	<span class="meta">#[cfg(target_arch = <span class="string">&quot;x86_64&quot;</span>)]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;into main &#123;&#125;&quot;</span>, hart_id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一步：打开 vmx</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = PerCpu::&lt;HyperCraftHalImpl&gt;::<span class="title function_ invoke__">new</span>(hart_id);</span><br><span class="line">        p.<span class="title function_ invoke__">hardware_enable</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二步：设置页表</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">gpm</span> = x64::<span class="title function_ invoke__">setup_gpm</span>(hart_id).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">npt</span> = gpm.<span class="title function_ invoke__">nest_page_table_root</span>();   <span class="comment">// 页表根节点物理地址</span></span><br><span class="line">        info!(<span class="string">&quot;&#123;:#x?&#125;&quot;</span>, gpm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第三步，创建虚拟机需要的 vcpu</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vcpus</span> = VmCpus::&lt;HyperCraftHalImpl, X64VcpuDevices&lt;HyperCraftHalImpl&gt;&gt;::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        vcpus.<span class="title function_ invoke__">add_vcpu</span>(VCpu::<span class="title function_ invoke__">new</span>(<span class="number">0</span>, p.<span class="title function_ invoke__">vmcs_revision_id</span>(), <span class="number">0x7c00</span>, npt).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vm</span> = VM::&lt;HyperCraftHalImpl, X64VcpuDevices&lt;HyperCraftHalImpl&gt;, X64VmDevices&lt;HyperCraftHalImpl&gt;&gt;::<span class="title function_ invoke__">new</span>(vcpus);</span><br><span class="line">        vm.<span class="title function_ invoke__">bind_vcpu</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hart_id == <span class="number">0</span> &#123;   <span class="comment">// 主 cpu 执行</span></span><br><span class="line">            <span class="keyword">let</span> (_, dev) = vm.<span class="title function_ invoke__">get_vcpu_and_device</span>(<span class="number">0</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            *(dev.console.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">backend</span>()) = device::device_emu::MultiplexConsoleBackend::Primary;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> <span class="variable">v</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">256</span> &#123;</span><br><span class="line">                libax::hv::<span class="title function_ invoke__">set_host_irq_enabled</span>(v, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Running guest...&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, vm.<span class="title function_ invoke__">run_vcpu</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        p.<span class="title function_ invoke__">hardware_disable</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第一步：打开-vmx"><a href="#第一步：打开-vmx" class="headerlink" title="第一步：打开 vmx"></a>第一步：打开 vmx</h3><p>首先看 PerCpu 相关数据结构：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arceos/crates/hypercraft/src/arch/x86_64/percpu.rs</span></span><br><span class="line"><span class="comment">/// Host per-CPU states to run the guest. All methods must be called on the corresponding CPU.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PerCpu</span>&lt;H: HyperCraftHal&gt; &#123;</span><br><span class="line">    cpu_id: <span class="type">usize</span>,  <span class="comment">// 物理 cpu-id</span></span><br><span class="line">    arch: VmxPerCpuState&lt;H&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arceos/crates/hypercraft/src/arch/x86_64/vmx/percpu.rs</span></span><br><span class="line"><span class="comment">/// State per vmx physical cpu.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">VmxPerCpuState</span>&lt;H: HyperCraftHal&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">super</span>) vmcs_revision_id: <span class="type">u32</span>,</span><br><span class="line">    vmx_region: VmxRegion&lt;H&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arceos/crates/hypercraft/src/arch/x86_64/vmx/region.rs</span></span><br><span class="line"><span class="comment">/// VMCS/VMXON region in 4K size. (SDM Vol. 3C, Section 24.2)</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">VmxRegion</span>&lt;H: HyperCraftHal&gt; &#123;</span><br><span class="line">    frame: PhysFrame&lt;H&gt;,        <span class="comment">// 4K 页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PerCpu 与一个逻辑 cpu 绑定，进行 vmx 的启动与关闭等操作。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal&gt; PerCpu&lt;H&gt; &#123;</span><br><span class="line">    <span class="comment">/// Create an uninitialized instance.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(cpu_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            cpu_id: cpu_id,     <span class="comment">// 物理 cpu id</span></span><br><span class="line">            arch: VmxPerCpuState::<span class="title function_ invoke__">new</span>(),    <span class="comment">// vmcs_revision_id 为 0，VmxRegion 未分配空间</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Whether the current CPU has hardware virtualization enabled.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_enabled</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.arch.<span class="title function_ invoke__">is_enabled</span>()  <span class="comment">// 检查 CR4 寄存器 VMXE 是否打开</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Enable hardware virtualization on the current CPU.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hardware_enable</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HyperResult &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.arch.<span class="title function_ invoke__">hardware_enable</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                info!(<span class="string">&quot;VMX enabled on cpu &#123;&#125;.&quot;</span>, <span class="keyword">self</span>.cpu_id);</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">            &#125;,</span><br><span class="line">            e @ <span class="title function_ invoke__">Err</span>(_) =&gt; &#123;</span><br><span class="line">                e</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Disable hardware virtualization on the current CPU.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hardware_disable</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HyperResult &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.arch.<span class="title function_ invoke__">hardware_disable</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                info!(<span class="string">&quot;VMX disabled on cpu &#123;&#125;.&quot;</span>, <span class="keyword">self</span>.cpu_id);</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">            &#125;,</span><br><span class="line">            e @ <span class="title function_ invoke__">Err</span>(_) =&gt; &#123;</span><br><span class="line">                e</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get current vmcs revision id.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">vmcs_revision_id</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.arch.<span class="title function_ invoke__">vmcs_revision_id</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">PerCpu</span>&lt;H&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_enabled</span>() &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">hardware_disable</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第二步，设置页表"><a href="#第二步，设置页表" class="headerlink" title="第二步，设置页表"></a>第二步，设置页表</h3><p>现在需要支持两个虚拟机，所以内存只分配两个虚拟机的量。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[repr(align(4096))]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">super</span>) <span class="keyword">struct</span> <span class="title class_">AlignedMemory</span>&lt;<span class="keyword">const</span> LEN: <span class="type">usize</span>&gt;([<span class="type">u8</span>; LEN]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两个虚拟机的内存空间，大小为 GUEST_PHYS_MEMORY_SIZE（16M）</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">super</span>) <span class="keyword">static</span> <span class="keyword">mut</span> GUEST_PHYS_MEMORY: [AlignedMemory&lt;GUEST_PHYS_MEMORY_SIZE&gt;; <span class="number">2</span>] =</span><br><span class="line">    [<span class="title function_ invoke__">AlignedMemory</span>([<span class="number">0</span>; GUEST_PHYS_MEMORY_SIZE]), <span class="title function_ invoke__">AlignedMemory</span>([<span class="number">0</span>; GUEST_PHYS_MEMORY_SIZE])];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取第 id 个虚拟机的 guest_paddr 对应的物理机虚拟地址</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">gpa_as_mut_ptr</span>(id: <span class="type">usize</span>, guest_paddr: GuestPhysAddr) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> <span class="type">u8</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">offset</span> = <span class="keyword">unsafe</span> &#123; &amp;(GUEST_PHYS_MEMORY[id]) <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">host_vaddr</span> = guest_paddr + offset;</span><br><span class="line">    host_vaddr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 host 物理地址为 hpa，大小为 size 的镜像复制到第 id 个虚拟机的物理地址为 load_gpa 处。</span></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="string">&quot;x86_64&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">load_guest_image</span>(id: <span class="type">usize</span>, hpa: HostPhysAddr, load_gpa: GuestPhysAddr, size: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">image_ptr</span> = <span class="type">usize</span>::<span class="title function_ invoke__">from</span>(<span class="title function_ invoke__">phys_to_virt</span>(hpa.<span class="title function_ invoke__">into</span>())) <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>; <span class="comment">// host 物理地址转为 host 虚拟地址</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">image</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts</span>(image_ptr, size) &#125;;</span><br><span class="line"></span><br><span class="line">    trace!(<span class="string">&quot;loading to guest memory: host &#123;:#x&#125; to guest &#123;:#x&#125;, size &#123;:#x&#125;&quot;</span>, image_ptr <span class="keyword">as</span> <span class="type">usize</span>, load_gpa, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(<span class="title function_ invoke__">gpa_as_mut_ptr</span>(id, load_gpa), size).<span class="title function_ invoke__">copy_from_slice</span>(image)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="string">&quot;x86_64&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">setup_gpm</span>(id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HyperResult&lt;GuestPhysMemorySet&gt; &#123;</span><br><span class="line">    <span class="comment">// copy BIOS and guest images</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">load_guest_image</span>(id, BIOS_PADDR, BIOS_ENTRY, BIOS_SIZE);</span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;guest_nimbos&quot;</span>)]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">load_guest_image</span>(id, GUEST_IMAGE_PADDR, GUEST_ENTRY, GUEST_IMAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create nested page table and add mapping</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gpm</span> = GuestPhysMemorySet::<span class="title function_ invoke__">new</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">guest_memory_regions</span> = [</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// Low RAM</span></span><br><span class="line">            gpa: GUEST_PHYS_MEMORY_BASE,</span><br><span class="line">            hpa: <span class="title function_ invoke__">virt_to_phys</span>((<span class="title function_ invoke__">gpa_as_mut_ptr</span>(id, GUEST_PHYS_MEMORY_BASE) <span class="keyword">as</span> HostVirtAddr).<span class="title function_ invoke__">into</span>()).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            size: GUEST_PHYS_MEMORY_SIZE,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::EXECUTE,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="meta">#[cfg(feature = <span class="string">&quot;guest_linux&quot;</span>)]</span></span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// Low RAM2</span></span><br><span class="line">            gpa: <span class="number">0x100_0000</span>,</span><br><span class="line">            hpa: <span class="number">0x6100_0000</span>,</span><br><span class="line">            size: <span class="number">0xf00_0000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::EXECUTE,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="meta">#[cfg(feature = <span class="string">&quot;guest_linux&quot;</span>)]</span></span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// RAM</span></span><br><span class="line">            gpa: <span class="number">0x7000_0000</span>,</span><br><span class="line">            hpa: <span class="number">0x7000_0000</span>,</span><br><span class="line">            size: <span class="number">0x1000_0000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::EXECUTE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// PCI</span></span><br><span class="line">            gpa: <span class="number">0x8000_0000</span>,</span><br><span class="line">            hpa: <span class="number">0x8000_0000</span>,</span><br><span class="line">            size: <span class="number">0x1000_0000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            gpa: <span class="number">0xfe00_0000</span>,</span><br><span class="line">            hpa: <span class="number">0xfe00_0000</span>,</span><br><span class="line">            size: <span class="number">0x1_0000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            gpa: <span class="number">0xfeb0_0000</span>,</span><br><span class="line">            hpa: <span class="number">0xfeb0_0000</span>,</span><br><span class="line">            size: <span class="number">0x10_0000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// IO APIC</span></span><br><span class="line">            gpa: <span class="number">0xfec0_0000</span>,</span><br><span class="line">            hpa: <span class="number">0xfec0_0000</span>,</span><br><span class="line">            size: <span class="number">0x1000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// HPET</span></span><br><span class="line">            gpa: <span class="number">0xfed0_0000</span>,</span><br><span class="line">            hpa: <span class="number">0xfed0_0000</span>,</span><br><span class="line">            size: <span class="number">0x1000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">        GuestMemoryRegion &#123;</span><br><span class="line">            <span class="comment">// Local APIC</span></span><br><span class="line">            gpa: <span class="number">0xfee0_0000</span>,</span><br><span class="line">            hpa: <span class="number">0xfee0_0000</span>,</span><br><span class="line">            size: <span class="number">0x1000</span>,</span><br><span class="line">            flags: MappingFlags::READ | MappingFlags::WRITE | MappingFlags::DEVICE,</span><br><span class="line">        &#125;,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> guest_memory_regions.<span class="title function_ invoke__">into_iter</span>() &#123;</span><br><span class="line">        gpm.<span class="title function_ invoke__">map_region</span>(r.<span class="title function_ invoke__">into</span>())?;  <span class="comment">// 建立虚拟机内存映射</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(gpm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三步，创建虚拟机需要的-vcpu"><a href="#第三步，创建虚拟机需要的-vcpu" class="headerlink" title="第三步，创建虚拟机需要的 vcpu"></a>第三步，创建虚拟机需要的 vcpu</h3><p>首先阅读 VmCpus 相关数据结构。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The maximum number of CPUs we can support.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> MAX_CPUS: <span class="type">usize</span> = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> VM_CPUS_MAX: <span class="type">usize</span> = MAX_CPUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The set of vCPUs in a VM.</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">VmCpus</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;&gt; &#123;</span><br><span class="line">    inner: [Once&lt;VCpu&lt;H&gt;&gt;; VM_CPUS_MAX],    <span class="comment">// Once：https://zhuanlan.zhihu.com/p/272848155</span></span><br><span class="line">    device: [Once&lt;PD&gt;; VM_CPUS_MAX],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;&gt; VmCpus&lt;H, PD&gt; &#123;</span><br><span class="line">    <span class="comment">/// Creates a new vCPU tracking structure.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            inner: [Once::INIT; VM_CPUS_MAX],</span><br><span class="line">            device: [Once::INIT; VM_CPUS_MAX],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Adds the given vCPU to the set of vCPUs.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_vcpu</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vcpu: VCpu&lt;H&gt;) <span class="punctuation">-&gt;</span> HyperResult&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vcpu_id</span> = vcpu.<span class="title function_ invoke__">vcpu_id</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">once_entry</span> = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">get</span>(vcpu_id).<span class="title function_ invoke__">ok_or</span>(HyperError::BadState)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">real_vcpu</span> = once_entry.<span class="title function_ invoke__">call_once</span>(|| vcpu);  <span class="comment">// 初始化第 vcpu_id 个虚拟机的 vcpu</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">device_once_entry</span> = <span class="keyword">self</span>.device.<span class="title function_ invoke__">get</span>(vcpu_id).<span class="title function_ invoke__">ok_or</span>(HyperError::BadState)?;</span><br><span class="line"></span><br><span class="line">        device_once_entry.<span class="title function_ invoke__">call_once</span>(|| PD::<span class="title function_ invoke__">new</span>(real_vcpu).<span class="title function_ invoke__">unwrap</span>()); <span class="comment">// 初始化第 vcpu_id 个虚拟机的 device</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns a reference to the vCPU with `vcpu_id` if it exists.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_vcpu_and_device</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vcpu_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HyperResult&lt;(&amp;<span class="keyword">mut</span> VCpu&lt;H&gt;, &amp;<span class="keyword">mut</span> PD)&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vcpu</span> = <span class="keyword">self</span></span><br><span class="line">            .inner</span><br><span class="line">            .<span class="title function_ invoke__">get_mut</span>(vcpu_id)</span><br><span class="line">            .<span class="title function_ invoke__">and_then</span>(|once| once.<span class="title function_ invoke__">get_mut</span>())</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(HyperError::NotFound)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">device</span> = <span class="keyword">self</span></span><br><span class="line">            .device</span><br><span class="line">            .<span class="title function_ invoke__">get_mut</span>(vcpu_id)</span><br><span class="line">            .<span class="title function_ invoke__">and_then</span>(|once| once.<span class="title function_ invoke__">get_mut</span>())</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(HyperError::NotFound)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>((vcpu, device))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Safety: Each VCpu is wrapped with a Mutex to provide safe concurrent access to VCpu.</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">VmCpus</span>&lt;H, PD&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">VmCpus</span>&lt;H, PD&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A virtual CPU within a guest.</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">VmxVcpu</span>&lt;H: HyperCraftHal&gt; &#123;</span><br><span class="line">    <span class="comment">// DO NOT modify `guest_regs` and `host_stack_top` and their order unless you do know what you are doing!</span></span><br><span class="line">    <span class="comment">// DO NOT add anything before or between them unless you do know what you are doing!</span></span><br><span class="line">    guest_regs: GeneralRegisters,   <span class="comment">// guest 通用寄存器</span></span><br><span class="line">    host_stack_top: <span class="type">u64</span>,            </span><br><span class="line">    vcpu_id: <span class="type">usize</span>,                 <span class="comment">// vcpu id。因为现在只支持单核，所以只能为 0 </span></span><br><span class="line">    launched: <span class="type">bool</span>,                 </span><br><span class="line">    vmcs: VmxRegion&lt;H&gt;,</span><br><span class="line">    msr_bitmap: MsrBitmap&lt;H&gt;,</span><br><span class="line">    pending_events: VecDeque&lt;(<span class="type">u8</span>, <span class="type">Option</span>&lt;<span class="type">u32</span>&gt;)&gt;,</span><br><span class="line">    xstate: XState,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal&gt; VmxVcpu&lt;H&gt; &#123;</span><br><span class="line">    <span class="comment">/// Create a new [`VmxVcpu`].</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(</span><br><span class="line">        vcpu_id: <span class="type">usize</span>,</span><br><span class="line">        vmcs_revision_id: <span class="type">u32</span>,</span><br><span class="line">        entry: GuestPhysAddr,</span><br><span class="line">        ept_root: HostPhysAddr,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> HyperResult&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        XState::<span class="title function_ invoke__">enable_xsave</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vcpu</span> = <span class="keyword">Self</span> &#123;</span><br><span class="line">            guest_regs: GeneralRegisters::<span class="title function_ invoke__">default</span>(),</span><br><span class="line">            host_stack_top: <span class="number">0</span>,</span><br><span class="line">            vcpu_id,</span><br><span class="line">            launched: <span class="literal">false</span>,</span><br><span class="line">            vmcs: VmxRegion::<span class="title function_ invoke__">new</span>(vmcs_revision_id, <span class="literal">false</span>)?,</span><br><span class="line">            msr_bitmap: MsrBitmap::<span class="title function_ invoke__">passthrough_all</span>()?,</span><br><span class="line">            pending_events: VecDeque::<span class="title function_ invoke__">with_capacity</span>(<span class="number">8</span>),</span><br><span class="line">            xstate: XState::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        vcpu.<span class="title function_ invoke__">setup_msr_bitmap</span>()?;   <span class="comment">// 设置 msr_bitmap，使 vmm 拦截 IA32_APIC_BASE MSR accesses，all x2APIC MSR accesses</span></span><br><span class="line">        vcpu.<span class="title function_ invoke__">setup_vmcs</span>(entry, ept_root)?;  <span class="comment">// 设置 vmcs</span></span><br><span class="line">        info!(<span class="string">&quot;[HV] created VmxVcpu(vmcs: &#123;:#x&#125;)&quot;</span>, vcpu.vmcs.<span class="title function_ invoke__">phys_addr</span>());</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(vcpu)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第四步，将新创建的-vcpu-加入到-vm"><a href="#第四步，将新创建的-vcpu-加入到-vm" class="headerlink" title="第四步，将新创建的 vcpu 加入到 vm"></a>第四步，将新创建的 vcpu 加入到 vm</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// VM define.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">VM</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;, VD: PerVmDevices&lt;H&gt;&gt; &#123;</span><br><span class="line">    vcpus: VmCpus&lt;H, PD&gt;,   <span class="comment">// 虚拟机持有的 vcpu</span></span><br><span class="line">    vcpu_bond: BitSet,      <span class="comment">// 索引是 vcpuid，位图，代表 cpu 上正在运行的 vcpu。</span></span><br><span class="line">    device: VD,             <span class="comment">// 每个虚拟机拥有的设备</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;, VD: PerVmDevices&lt;H&gt;&gt; VM&lt;H, PD, VD&gt; &#123;</span><br><span class="line">    <span class="comment">/// Create a new [`VM`].</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(vcpus: VmCpus&lt;H, PD&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123; vcpus, vcpu_bond: BitSet::<span class="title function_ invoke__">new</span>(), device: VD::<span class="title function_ invoke__">new</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Bind the specified [`VCpu`] to current physical processor.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">bind_vcpu</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vcpu_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HyperResult&lt;(&amp;<span class="keyword">mut</span> VCpu&lt;H&gt;, &amp;<span class="keyword">mut</span> PD)&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.vcpu_bond.<span class="title function_ invoke__">contains</span>(vcpu_id) &#123;  </span><br><span class="line">            <span class="title function_ invoke__">Err</span>(HyperError::InvalidParam)   <span class="comment">// 已绑定</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.vcpus.<span class="title function_ invoke__">get_vcpu_and_device</span>(vcpu_id) &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>((vcpu, device)) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">self</span>.vcpu_bond.<span class="title function_ invoke__">insert</span>(vcpu_id);     <span class="comment">// vcpu-id 位置 1</span></span><br><span class="line">                    vcpu.<span class="title function_ invoke__">bind_to_current_processor</span>()?;  <span class="comment">// 使用 vmptrld 与现有 cpu 绑定</span></span><br><span class="line">                    <span class="title function_ invoke__">Ok</span>((vcpu, device))</span><br><span class="line">                &#125;,</span><br><span class="line">                e @ <span class="title function_ invoke__">Err</span>(_) =&gt; e,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第五步，运行-vm"><a href="#第五步，运行-vm" class="headerlink" title="第五步，运行 vm"></a>第五步，运行 vm</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal, PD: PerCpuDevices&lt;H&gt;, VD: PerVmDevices&lt;H&gt;&gt; VM&lt;H, PD, VD&gt; &#123;</span><br><span class="line">    <span class="meta">#[allow(unreachable_code)]</span></span><br><span class="line">    <span class="comment">/// Run a specified [`VCpu`] on current logical vcpu.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run_vcpu</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vcpu_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HyperResult &#123;</span><br><span class="line">        <span class="keyword">let</span> (vcpu, vcpu_device) = <span class="keyword">self</span>.vcpus.<span class="title function_ invoke__">get_vcpu_and_device</span>(vcpu_id).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(exit_info) = vcpu.<span class="title function_ invoke__">run</span>() &#123;</span><br><span class="line">                <span class="comment">// we need to handle vm-exit this by ourselves</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable">result</span> = vcpu_device.<span class="title function_ invoke__">vmexit_handler</span>(vcpu, &amp;exit_info)</span><br><span class="line">                    .<span class="title function_ invoke__">or_else</span>(|| <span class="keyword">self</span>.device.<span class="title function_ invoke__">vmexit_handler</span>(vcpu, &amp;exit_info));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">match</span> result &#123;</span><br><span class="line">                    <span class="title function_ invoke__">Some</span>(result) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> result.<span class="title function_ invoke__">is_err</span>() &#123;</span><br><span class="line">                            <span class="built_in">panic!</span>(<span class="string">&quot;VM failed to handle a vm-exit: &#123;:?&#125;, error &#123;:?&#125;, vcpu: &#123;:#x?&#125;&quot;</span>, exit_info.exit_reason, result.<span class="title function_ invoke__">unwrap_err</span>(), vcpu);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">                        <span class="built_in">panic!</span>(<span class="string">&quot;nobody wants to handle this vm-exit: &#123;:?&#125;, vcpu: &#123;:#x?&#125;&quot;</span>, exit_info, vcpu);</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            vcpu_device.<span class="title function_ invoke__">check_events</span>(vcpu)?;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;H: HyperCraftHal&gt; VmxVcpu&lt;H&gt; &#123;</span><br><span class="line">    <span class="comment">/// Run the guest. It returns when a vm-exit happens and returns the vm-exit if it cannot be handled by this [`VmxVcpu`] itself.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;VmxExitInfo&gt; &#123;</span><br><span class="line">        <span class="comment">// Inject pending events</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.launched &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">inject_pending_events</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Run guest</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">load_guest_xstate</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.launched &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">vmx_resume</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.launched = <span class="literal">true</span>;</span><br><span class="line">                VmcsHostNW::RSP.<span class="title function_ invoke__">write</span>(&amp;<span class="keyword">self</span>.host_stack_top <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">vmx_launch</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">load_host_xstate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle vm-exits</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">exit_info</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">exit_info</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        trace!(<span class="string">&quot;VM exit: &#123;:#x?&#125;&quot;</span>, exit_info);    </span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cr4</span> = VmcsGuestNW::CR4.<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">if</span> cr4.<span class="title function_ invoke__">get_bit</span>(<span class="number">18</span>) &#123;</span><br><span class="line">            <span class="comment">// panic!(&quot;osxsave dead!&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.<span class="title function_ invoke__">builtin_vmexit_handler</span>(&amp;exit_info) &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(result) =&gt; &#123;   </span><br><span class="line">                <span class="keyword">if</span> result.<span class="title function_ invoke__">is_err</span>() &#123;</span><br><span class="line">                    <span class="built_in">panic!</span>(<span class="string">&quot;VmxVcpu failed to handle a VM-exit that should be handled by itself: &#123;:?&#125;, error &#123;:?&#125;, vcpu: &#123;:#x?&#125;&quot;</span>, exit_info.exit_reason, result.<span class="title function_ invoke__">unwrap_err</span>(), <span class="keyword">self</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">None</span> =&gt; <span class="title function_ invoke__">Some</span>(exit_info),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/f4d3d34.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/f4d3d34.html" class="post-title-link" itemprop="url">Webassembly 学习（2）Structure</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-12-04 11:35:29 / 修改时间：16:57:18" itemprop="dateCreated datePublished" datetime="2023-12-04T11:35:29+08:00">2023-12-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Conventions"><a href="#Conventions" class="headerlink" title="Conventions"></a>Conventions</h2><p>WebAssembly 是一种具有多种具体表示形式（二进制格式和文本格式）的编程语言。两者都映射到一个共同的结构。为了简洁起见，该结构以抽象语法的形式描述。本规范的所有部分都是根据此抽象语法定义的。</p>
<h3 id="语法符号"><a href="#语法符号" class="headerlink" title="语法符号"></a>语法符号</h3><p>在定义抽象语法的语法规则时采用以下约定。</p>
<ul>
<li>Terminal symbols（原子）以无衬线字体或符号形式书写：i32、end。</li>
<li>Nonterminal symbols 用斜体书写: <em>valtype</em>, <em>instr</em>。</li>
<li>𝐴<sup>𝑛</sup> 是 𝑛 ≥ 0 次 𝐴 迭代的序列。</li>
<li>𝐴* 是 𝐴 的可能为空的迭代序列。（这是 𝐴<sup>𝑛</sup> 的简写，在 𝑛 不相关的情况下使用。）</li>
<li>𝐴<sup>+</sup> 是 𝐴 的非空迭代序列。 （这是 𝐴<sup>𝑛</sup> 的简写，其中 𝑛 ≥ 1。）</li>
<li>𝐴<sup>?</sup> 是 𝐴 的可选出现。 （这是 𝐴<sup>𝑛</sup> 的简写，其中 𝑛 ≤ 1。）</li>
<li>Productions are written <em>sym</em> ::&#x3D; 𝐴<sub>1</sub> | . . . | 𝐴<sub>𝑛</sub>.</li>
<li>大型作品可以分为多个定义，通过用明确的省略号结束第一个定义来表示， <em>sym</em> ::&#x3D; 𝐴<sub>1</sub> | …，并以省略号开始延续 <em>sym</em> ::&#x3D; … | 𝐴<sub>2</sub></li>
<li>一些产生式通过括号中的附加条件“（如果条件）”进行了增强，这为将产生式组合扩展为许多单独的情况提供了简写。</li>
</ul>
<h3 id="辅助符号"><a href="#辅助符号" class="headerlink" title="辅助符号"></a>辅助符号</h3><p>在处理句法结构时，还使用以下符号：</p>
<ul>
<li>𝜖 表示空序列</li>
<li>|𝑠| 表示序列 𝑠 的长度。</li>
<li>𝑠[𝑖] 表示序列 𝑠 的第 𝑖 个元素，从 0 开始。</li>
<li>𝑠[𝑖:𝑛] 表示子序列 𝑠[𝑖] … 𝑠[𝑖 + 𝑛 − 1]。</li>
<li>𝑠 with [𝑖] &#x3D; 𝐴 表示与 𝑠 相同的序列，只是将第 𝑖 个元素替换为 𝐴</li>
<li>𝑠 with [𝑖 : 𝑛] &#x3D; 𝐴<sup>𝑛</sup> 表示与 𝑠 相同的序列，只不过子序列 𝑠[𝑖 : 𝑛] 被替换为 𝐴<sup>𝑛</sup></li>
<li>concat(𝑠*) 表示将 𝑠* 中的所有序列 𝑠<sub>𝑖</sub> 连接起来形成的平坦序列</li>
</ul>
<p>此外，还采用以下约定：</p>
<ul>
<li>符号 𝑥<sup>𝑛</sup>（其中 𝑥 是非终结符）被视为范围在各个𝑥 序列上的元变量（𝑥*、𝑥<sup>+</sup>、𝑥<sup>？</sup> 类似）。</li>
<li>当给定序列 𝑥<sup>𝑛</sup> 时，则假定在 (𝐴<sub>1</sub> 𝑥 𝐴<sub>2</sub>)<sup>𝑛</sup> 序列中出现的 𝑥 与 𝑥<sup>𝑛</sup> 逐点对应（对于𝑥*、𝑥<sup>+</sup>、𝑥<sup>？</sup>类似）。 这隐式地表达了一种在序列上映射句法结构的形式.</li>
</ul>
<p>以下形式的产生式被解释为将一组固定字段 field<sub>𝑖</sub> 分别映射到值 𝐴<sub>𝑖</sub> 的记录:<br>r ::&#x3D; {field<sub>1</sub> 𝐴<sub>1</sub>, field<sub>2</sub> 𝐴<sub>2</sub>, . . . }</p>
<p>采用以下符号来处理此类记录</p>
<ul>
<li>𝑟.field 表示 𝑟 的 field 组件的内容。</li>
<li>𝑟 with field &#x3D; 𝐴 表示与 𝑟 相同的记录，只是用 𝐴 替换了 field 组件的内容。</li>
<li>𝑟1 ⊕ 𝑟2 表示通过逐点附加每个序列来组合具有相同序列字段的两个记录：<br>{field<sub>1</sub> 𝐴*<sub>1</sub>, field<sub>2</sub> 𝐴*<sub>2</sub>, …} ⊕ {field<sub>1</sub> 𝐵*<sub>1</sub>, field<sub>2</sub> 𝐵*<sub>2</sub>,…} &#x3D; {field<sub>1</sub> 𝐴*<sub>1</sub>𝐵*<sub>1</sub> , field<sub>2</sub> 𝐴*<sub>2</sub> 𝐵*<sub>2</sub>,…}</li>
<li>⨁︀𝑟*分别表示记录序列的组成；如果序列为空，则结果记录的所有字段均为空。</li>
</ul>
<p>序列和记录的更新表示法递归地概括为通过“路径” pth ::&#x3D; ([…] | .field)+ 访问的嵌套组件：</p>
<ul>
<li>𝑠 with [𝑖] pth &#x3D; 𝐴 是 𝑠 with [𝑖] &#x3D; (𝑠[𝑖] with pth &#x3D; 𝐴) 的缩写</li>
<li>𝑟 with field pth &#x3D; 𝐴 是 𝑟 with field &#x3D; (𝑟.field with pth &#x3D; 𝐴) 的缩写</li>
<li>𝑟 with .field &#x3D; 𝐴 被缩短为 𝑟 with field &#x3D; 𝐴</li>
</ul>
<h3 id="Vectors"><a href="#Vectors" class="headerlink" title="Vectors"></a>Vectors</h3><p>向量是 𝐴<sup>𝑛</sup> （或 𝐴*）形式的有界序列，其中 𝐴 可以是值或复杂的结构。 向量最多可以有 2<sup>32</sup> − 1 个元素。<br>vec(𝐴) ::&#x3D; 𝐴<sup>𝑛</sup>（如果 𝑛 &lt; 2<sup>32</sup>）</p>
<h2 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h2><p>WebAssembly 程序对原始数值进行操作。此外，在程序的定义中，不可变的值序列出现来表示更复杂的数据，例如文本字符串或其他向量。</p>
<h3 id="字节"><a href="#字节" class="headerlink" title="字节"></a>字节</h3><p>最简单的值形式是原始的未解释字节。 在抽象语法中，它们表示为十六进制文字。</p>
<p>byte ::&#x3D; 0x00 | . . . | 0xFF</p>
<p>元变量𝑏的范围超过字节。<br>字节有时被解释为自然数 𝑛 &lt; 256。</p>
<h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h3><p>具有不同值范围的不同类别的整数通过其位宽 𝑁 以及它们是无符号还是有符号来区分。</p>
<p>u𝑁 ::&#x3D; 0 | 1 | … | 2<sup>𝑁</sup> −1</p>
<p>s𝑁 ::&#x3D; −2<sup>𝑁−1</sup>  | … | −1 | 0 | 1 | … | 2<sup>𝑁−1</sup> −1</p>
<p>i𝑁 ::&#x3D; u𝑁</p>
<p>类 i𝑁 定义了未解释的整数，其符号解释可能会根据上下文而变化。 在抽象语法中，它们表示为无符号值。但是，某些操作会根据二进制补码解释将它们转换为有符号。</p>
<p>注意：本规范中出现的主要整数类型是 u32、u64、 s32、 s64、 i8、i16 、i32 、i64。然而，其他大小作为辅助结构出现，例如，在浮点数的定义中。</p>
<p>元变量 𝑚、𝑛、𝑖 的范围为整数.<br>数字可以用简单的算术表示，如上面的语法所示。为了区分像 2<sup>𝑁</sup> 这样的算术和像 (1)<sup>𝑁</sup> 这样的序列，后者用括号来区分。</p>
<h3 id="浮点"><a href="#浮点" class="headerlink" title="浮点"></a>浮点</h3><p>浮点数据表示 32 或 64 位值，对应于 IEEE 754 标准的相应二进制格式。<br>每个值都有一个符号和一个量纲。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/95362efb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/95362efb.html" class="post-title-link" itemprop="url">WebAssembly 学习（1）Introduction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-12-04 10:08:40 / 修改时间：11:36:12" itemprop="dateCreated datePublished" datetime="2023-12-04T10:08:40+08:00">2023-12-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>WebAssembly（wasm）：safe，portable，low-level code format，专为高效执行和紧凑表示而设计。<br>它的主要目标是在 Web 上启用高性能应用程序，但它没有做出任何特定于 Web 的假设或提供特定于 Web 的功能，因此它也可以在其他环境中使用。</p>
<p>WebAssembly 是由 W3C 社区团体开发的开放标准。本文档介绍了核心 WebAssembly 标准的 2.0 版（草案 2023-12-01）。预计它将被未来具有附加功能的新增量版本所取代。</p>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><ul>
<li>Fast, safe, and portable semantics:<ul>
<li>快速：以接近本机代码的性能执行，利用所有当代硬件的通用功能。</li>
<li>安全：代码经过验证并在内存安全、沙盒环境中执行，防止数据损坏或安全漏洞。</li>
<li>明确定义：以一种易于非正式和正式推理的方式完整而精确地定义有效的程序及其行为。</li>
<li>独立于硬件：可以在所有现代架构、桌面或移动设备以及嵌入式系统上进行编译。</li>
<li>与语言无关：不特权任何特定语言、编程模型或对象模型。</li>
<li>平台无关：可以嵌入浏览器中，作为独立虚拟机运行，或集成在其他环境中。</li>
<li>开放：程序可以以简单且通用的方式与其环境进行互操作。</li>
</ul>
</li>
<li>高效且可移植的表示：<ul>
<li>紧凑：比典型文本或本机代码格式更小，传输速度更快的二进制格式。</li>
<li>模块化：程序可以分成更小的部分，可以单独传输、缓存和使用。</li>
<li>高效：可以在 a single pass 中进行解码、验证和编译，与即时 (JIT) 或提前 (AOT) 编译相同。</li>
<li>可流式传输：允许在看到所有数据之前尽快开始解码、验证和编译。</li>
<li>可并行化：允许将解码、验证和编译拆分为许多独立的并行任务。</li>
<li>可移植：不做出现代硬件未广泛支持的架构假设。</li>
</ul>
</li>
</ul>
<p>WebAssembly 代码还旨在易于检查和调试，尤其是在 Web 浏览器等环境中，但此类功能超出了本规范的范围。</p>
<h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h3><p>WebAssembly 的核心是虚拟指令集架构（虚拟 ISA）。因此，它有许多用例，并且可以嵌入到许多不同的环境中。 为了涵盖其多样性并实现最大程度的重用，WebAssembly 规范被拆分并分层为多个文档。</p>
<p>本文档涉及 WebAssembly 的核心 ISA 层。 它定义了指令集、二进制编码、验证和执行语义，以及文本表示。 然而，它没有定义 WebAssembly 程序如何与它们执行的特定环境交互，也没有定义如何从这样的环境中调用它们。</p>
<p>相反，该规范由定义特定嵌入环境（例如 Web）接口的附加文档来补充。 它们各自定义适合给定环境的 WebAssembly 应用程序编程接口 (API)。</p>
<h3 id="安全考虑"><a href="#安全考虑" class="headerlink" title="安全考虑"></a>安全考虑</h3><p>WebAssembly 不提供对执行代码的计算环境的环境访问。 与环境的任何交互，例如 I&#x2F;O、对资源的访问或操作系统调用，只能通过调用嵌入器（embedder）提供并导入到 WebAssembly 模块中的函数来执行。 嵌入器可以通过控制或限制可导入的功能来建立适合各自环境的安全策略。 这些考虑因素是嵌入者的责任，也是特定环境的 API 定义的主题。 由于 WebAssembly 被设计为可转换为直接在主机硬件上运行的机器代码，因此它可能容易受到硬件级别的侧通道攻击。 在存在此问题的环境中，嵌入器可能必须采取适当的缓解措施来隔离 WebAssembly 计算。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>WebAssembly 依赖于两个现有标准：</p>
<ul>
<li>IEEE 7544，用于浮点数据的表示和相应数字运算的语义。</li>
<li>Unicode5，用于表示导入&#x2F;导出名称和文本格式。<br>然而，为了使本规范自成一体，上述标准的相关方面被定义并形式化为本规范的一部分，例如浮点值的二进制表示和舍入，以及 Unicode 的值范围和 UTF-8 字符编码。</li>
</ul>
<p>注：上述标准是所有相关定义的权威来源。 本规范中给出的形式化旨在匹配这些定义。 所描述的语法或语义中的任何差异都将被视为错误。</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>Values：WebAssembly 仅提供四种基本数字类型。这些是整数和 IEEE 7546 数字，分别为 32 和 64 位宽度。32 位整数也用作布尔值和内存地址。这些类型的常用操作都可用，包括它们之间的完整转换矩阵。有符号和无符号整数类型之间没有区别。相反，整数被相应的操作解释为无符号或有符号的二进制补码表示形式。除了这些基本数字类型之外，还有一个 128 位宽的向量类型代表不同类型的打包数据。支持的表示形式为 4 个 32 位或 2 个 64 位 IEEE 7547 数字，或不同宽度的打包整数值，具体为 2 个 64 位整数、4 个 32 位整数、8 个 16 位整数或 16 个 8 位整数。最后，值可以由表示指向不同类型实体的指针的不透明引用组成。与其他类型不同，它们的大小或表示形式是不可观察的。</li>
<li>Instructions：WebAssembly 的计算模型基于堆栈机。代码由按顺序执行的指令序列组成。指令操作隐式操作数堆栈上的值，分为两大类。简单的指令对数据执行基本操作。它们从操作数堆栈中弹出参数并将结果推回操作数堆栈。控制指令改变控制流。控制流是结构化的，这意味着它是用良好嵌套的结构（例如块、循环和条件）来表达的。 分支只能针对此类构造。</li>
<li>Traps：在某些情况下，某些指令可能会产生陷阱，从而立即中止执行。陷阱无法由 WebAssembly 代码处理，但会报告给外部环境，通常可以在外部环境中捕获陷阱。</li>
<li>Functions：代码被组织成单独的函数。 每个函数都采用一系列值作为参数，并返回一系列值作为结果。 函数可以相互调用，包括递归调用，从而产生无法直接访问的隐式调用堆栈。 函数还可以声明可用作虚拟寄存器的可变局部变量。</li>
<li>Tables：表是特定元素类型的不透明值的数组。它允许程序通过动态索引操作数间接选择此类值。目前，唯一可用的元素类型是无类型函数引用或对外部主机值的引用。因此，程序可以通过表的动态索引间接调用函数。例如，这允许通过表索引来模拟函数指针。</li>
<li>Linear Memory：线性内存是一个连续的、可变的原始字节数组。这样的内存是用初始大小创建的，但可以动态增长。程序可以在任何字节地址（包括未对齐的）处从线性存储器加载值或将值存储到线性存储器。整数加载和存储可以指定小于相应值类型大小的存储大小。如果访问不在当前内存大小的范围内，则会发生陷阱。</li>
<li>Modules：WebAssembly 二进制文件采用模块的形式，其中包含函数、表和线性存储器的定义，以及可变或不可变的全局变量。还可以导入定义，指定模块&#x2F;名称对和合适的类型。每个定义都可以选择以一个或多个名称导出。除了定义之外，模块还可以为其存储器或表定义初始化数据，这些数据采用复制到给定偏移量的段的形式。他们还可以定义自动执行的启动函数。</li>
<li>Embedder：WebAssembly 实现通常会嵌入到主机环境中。 该环境定义了如何启动模块加载、如何提供导入（包括主机端定义）以及如何访问导出。 然而，任何特定嵌入的细节超出了本规范的范围，而是由补充的、特定于环境的 API 定义来提供。</li>
</ul>
<h3 id="Semantic-Phases"><a href="#Semantic-Phases" class="headerlink" title="Semantic Phases"></a>Semantic Phases</h3><p>从概念上讲，WebAssembly 的语义分为三个阶段。</p>
<ul>
<li>解码：WebAssembly 模块以二进制格式分发。解码处理格式并将其转换为模块的内部表示。在本规范中，这种表示形式是通过抽象语法建模的，但实际的实现可以直接编译为机器代码。</li>
<li>验证：解码的模块必须有效。验证会检查许多格式良好的条件，以保证模块有意义且安全。特别是，它对函数及其主体中的指令序列执行类型检查，例如确保操作数堆栈的使用一致。</li>
<li>执行：最后，可以执行有效的模块。 执行又可以分为两个阶段：<ul>
<li>Instantiation。模块实例是模块的动态表示，包含其自己的状态和执行堆栈。实例化执行模块主体本身，并给出其所有导入的定义。它初始化全局变量、内存和表，并调用模块的启动函数（如果已定义）。它返回模块导出的实例。</li>
<li>Invocation。实例化后，可以通过调用模块实例上的导出函数来启动进一步的 WebAssembly 计算。 给定所需的参数，执行相应的函数并返回其结果。<br>实例化和调用是嵌入环境中的操作。</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/e12ad5d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/e12ad5d.html" class="post-title-link" itemprop="url">从 0 开始构建 unikraft 应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-25 18:30:13" itemprop="dateCreated datePublished" datetime="2023-10-25T18:30:13+08:00">2023-10-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-07 19:20:14" itemprop="dateModified" datetime="2023-11-07T19:20:14+08:00">2023-11-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文档将从空函数，helloworld，redis 三个例子构建 unikraft qemu-x6_64 应用。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/p/e12ad5d.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/39b93952.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/39b93952.html" class="post-title-link" itemprop="url">Unikraft 安装与使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-23 23:45:57" itemprop="dateCreated datePublished" datetime="2023-10-23T23:45:57+08:00">2023-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 16:50:26" itemprop="dateModified" datetime="2023-10-25T16:50:26+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Unikraft-安装"><a href="#Unikraft-安装" class="headerlink" title="Unikraft 安装"></a>Unikraft 安装</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/p/39b93952.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/640bec68.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/640bec68.html" class="post-title-link" itemprop="url">SGX简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-10-09 07:57:44 / 修改时间：14:13:08" itemprop="dateCreated datePublished" datetime="2023-10-09T07:57:44+08:00">2023-10-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1、什么是-SGX？"><a href="#1、什么是-SGX？" class="headerlink" title="1、什么是 SGX？"></a>1、什么是 SGX？</h2><h2 id="2、为什么要使用-SGX？"><a href="#2、为什么要使用-SGX？" class="headerlink" title="2、为什么要使用 SGX？"></a>2、为什么要使用 SGX？</h2><h2 id="3、SGX-基本原理"><a href="#3、SGX-基本原理" class="headerlink" title="3、SGX 基本原理"></a>3、SGX 基本原理</h2><h2 id="4、"><a href="#4、" class="headerlink" title="4、"></a>4、</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/8e98bdb9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/8e98bdb9.html" class="post-title-link" itemprop="url">Unikraft 启动流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-08 23:22:09" itemprop="dateCreated datePublished" datetime="2023-10-08T23:22:09+08:00">2023-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-23 23:47:18" itemprop="dateModified" datetime="2023-10-23T23:47:18+08:00">2023-10-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Unikraft-调试"><a href="#Unikraft-调试" class="headerlink" title="Unikraft 调试"></a>Unikraft 调试</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/p/8e98bdb9.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/486c1af5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/486c1af5.html" class="post-title-link" itemprop="url">Unikernel简述</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-10-08 23:22:00 / 修改时间：23:25:45" itemprop="dateCreated datePublished" datetime="2023-10-08T23:22:00+08:00">2023-10-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peizhongqiu.github.io/p/9e9d1546.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lulu.jpg">
      <meta itemprop="name" content="Little_Q">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Little Q 的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/p/9e9d1546.html" class="post-title-link" itemprop="url">virtio介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-15 16:19:40" itemprop="dateCreated datePublished" datetime="2023-07-15T16:19:40+08:00">2023-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-08 23:25:45" itemprop="dateModified" datetime="2023-10-08T23:25:45+08:00">2023-10-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本部分内容摘自《Viitual I&#x2F;O Device(VIRTIO) Version 1.2》</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/p/9e9d1546.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Little_Q"
      src="/images/lulu.jpg">
  <p class="site-author-name" itemprop="name">Little_Q</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/PeizhongQiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PeizhongQiu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Little_Q</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
